<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Épopée - Exploitation</title>
  <!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
<link rel="icon" type="image/png" href="favicon.png"> <!-- fallback -->
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.css">
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // Indispensable avec pdf.js via CDN
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<style>
  #btnHistory { display: none; }
  body.admin #btnHistory { display: inline-block; }

:root{
  --bg:#f5f5f7; --panel:#ffffff; --text:#1c1c1e; --muted:#6e6e73; --border:#e5e5ea;
  --blue:#0a84ff; --green:#34c759; --red:#ff453a; --orange:#ff9f0a; --purple:#bf5af2; --grey:#8e8e93;
  --topbar-h:56px; 
}
  /* Masque le statut dans la barre du haut */
#statusText { display: none !important; }

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;color:var(--text);background:var(--bg)}
.app{display:grid;grid-template-rows:auto 1fr;height:100%}
.topbar{height:56px;background:var(--panel);display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:8px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1500}
.brand{font-weight:800}
.btn{border:1px solid var(--border);border-radius:12px;padding:9px 13px;font-weight:600;cursor:pointer;background:var(--panel);transition:transform .06s ease, box-shadow .2s ease, background .2s ease}
.btn:hover{box-shadow:0 6px 18px rgba(0,0,0,.06)}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--blue);color:#fff;border-color:transparent}
.btn.primary.flash{box-shadow:0 0 0 8px rgba(10,132,255,.15)}
.btn.success{background:var(--green);color:#fff;border-color:transparent}
.hint{font-size:12px;color:var(--muted)}

  /* Espace entre la toolbar FS et les KPIs */
.board.fullscreen .fs-toolbar{
  margin-bottom: 12px;    /* ↑ marge demandée */
}
/* Garde une zone libre à droite pour les boutons ronds de la board-actions */
.board.fullscreen .fs-toolbar{
  padding-right: 96px;    /* réserve ~2 boutons + marge */
}

/* Centre le bloc slider + bouton Export */
.fs-right{
  flex: 1 1 auto;                 /* s’étire comme la partie gauche */
  justify-content: center;        /* → centré */
  gap: 8px;
}

/* largeur du slider en FS + évite qu’il rapetisse */
.fs-right #fsOccTarget{
  width: 240px;                   /* un peu plus confortable */
  flex: 0 0 240px;
}

.fs-right .btn{
  flex-shrink: 0;                 /* “Exporter” ne se compacte pas */
}

  
.layout{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 56px);transition:grid-template-columns .24s ease;position:relative}
aside.panel{background:var(--panel);border-right:1px solid var(--border);padding:14px;overflow:auto;z-index:1400}
.layout.collapsed{grid-template-columns:0 1fr}
.layout.collapsed aside.panel{width:0;padding:0;border-right:0;overflow:hidden;pointer-events:none}
.field{margin:10px 0} label{font-size:12px;color:#3a3a3c;display:block;margin-bottom:6px}
.select,.input,.number{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:end}
.row3 .field label{min-height:32px;display:flex;align-items:flex-end;white-space:nowrap}
.number{height:40px}

.section{border-top:1px solid var(--border);margin:12px -14px;padding:12px 14px}
.section:first-of-type{border-top:0;margin-top:0}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.actions .btn{padding:8px 10px;border-radius:10px}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:flex;align-items:center;gap:4px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px}
.chip input{accent-color:var(--blue)}

#map{width:100%;height:100%;position:relative;background:#fafafa;z-index:100}

/* Drawer toggle */
.drawer-toggle{position:absolute;top:72px;left:360px;transform:translateX(-50%);z-index:1600;background:#fff;border:1px solid var(--border);border-radius:999px;width:30px;height:44px;box-shadow:0 6px 16px rgba(0,0,0,.08);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:left .24s ease}
.drawer-toggle span{
  font-weight:800;
  font-size:18px;
  line-height:1;
  color:var(--text);
}

.layout.collapsed .drawer-toggle{left:12px}
.layout.collapsed .drawer-toggle span{transform:rotate(180deg)}

/* Zoom + toolbar */
.controls-stack{position:absolute; top:72px; right:16px; z-index:1500; display:flex; flex-direction:column; gap:8px; align-items:flex-end}
.zoom-strip{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.08);display:flex;overflow:hidden}
.zoom-btn{user-select:none;cursor:pointer;font-weight:800;min-width:44px;text-align:center;padding:10px 14px;border-right:1px solid var(--border)}
.zoom-btn:last-child{border-right:0}
.zoom-btn:active{background:#f2f2f7}
.leaflet-pm-toolbar{top:128px !important; right:16px !important; transform:none !important; z-index:1400 !important}
/* Cacher les boutons +/- et le tiroir en plein écran dashboard */
body.dashboard-fullscreen .controls-stack,
body.dashboard-fullscreen #drawerToggle{
  display: none !important;
}

/* (optionnel) masquer aussi la barre Geoman */
body.dashboard-fullscreen .leaflet-pm-toolbar{
  display: none !important;
}

/* Hide Geoman in visitor mode */
body.visitor .leaflet-pm-toolbar{display:none !important}

/* Mode switch */
.mode-switch{position:absolute;bottom:16px;right:16px;z-index:1500;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:flex;align-items:center;gap:8px;box-shadow:0 8px 20px rgba(0,0,0,.08);font-size:12px;color:#1c1c1e}
.switch{position:relative;width:52px;height:28px;border-radius:999px;background:#e5e5ea;cursor:pointer;flex:0 0 auto}
.switch input{display:none}
.knob{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:transform .18s ease}
.switch input:checked ~ .knob{transform:translateX(24px)}
.track{position:absolute;inset:0;border-radius:999px;background:#e5e5ea;transition:background .18s ease}
.switch input:checked ~ .track{background:var(--blue)}

/* PIN modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:3000}
.modal.open{display:flex}
.pad{width:360px;max-width:calc(100vw - 32px);background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:16px;border:1px solid var(--border)}
.pad h4{margin:0 0 6px 0}
.dots{display:flex;gap:8px;margin:6px 0 12px 0;justify-content:center}
.dot{width:10px;height:10px;border-radius:50%;background:#e5e5ea}
.dot.active{background:var(--blue)}
.keygrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.key{padding:16px 0;background:#f8f8f9;border:1px solid var(--border);border-radius:12px;cursor:pointer;font-weight:800;text-align:center;font-size:18px;user-select:none}
.key:active{background:#f1f1f4}
.key.icon{font-size:16px}
.key.primary{background:var(--blue);border-color:transparent;color:#fff}
.key.primary:active{filter:brightness(.98)}
.key[disabled]{opacity:.5;pointer-events:none}

/* Dashboard */
.board{position:absolute; top:72px; left:380px; z-index:1300; background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px 14px; box-shadow:0 10px 30px rgba(0,0,0,.08); min-width:340px; max-width:720px; display:none}
.board h4{margin:0 0 8px 0}
.board .sub{color:var(--muted); font-size:12px; margin-bottom:10px; display:flex; align-items:center; gap:8px}
.scope{display:flex; gap:8px; align-items:center}
.scope select{padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:12px}
.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.kpi{background:#f8f8f9;border:1px solid var(--border);border-radius:12px;padding:10px}
.kpi .v{font-weight:800;font-size:18px}
.kpi .l{font-size:12px;color:#3a3a3c}
.kpi .subl{font-size:10.5px;color:var(--muted)}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px}
.card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px}
.card h5{margin:0 0 6px 0; font-size:13px}
.canvas-wrap{width:100%; height:220px; display:flex; align-items:center; justify-content:center}
canvas{width:100%; height:200px}
.board .board-actions{position:absolute;top:8px;right:8px;display:flex;gap:8px;z-index:5}
.board .iconbtn{width:32px;height:32px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,.08);font-size:16px;line-height:1}
.board .iconbtn:hover{background:#f5f5f7}
.board.fullscreen{position:fixed;inset:12px;max-width:none;min-width:unset;left:12px;right:12px;top:12px;bottom:12px;overflow:auto;z-index:3000}

  /* ==== Améliorations Dashboard – plein écran uniquement ==== */
.board.fullscreen{ padding:16px 18px; }
  /* Compacter la ligne "Bâtiment A" dans la toolbar FS */
.fs-toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; }
.fs-left    { flex:0 0 auto; display:flex; align-items:center; gap:8px; } /* ne s'étire plus */
.fs-right   { display:flex; align-items:center; gap:8px; }

.fs-toolbar .select,
#kpiScopeFS{
  width:auto !important;     /* écrase le width:100% global */
  min-width:160px;
  max-width:220px;           /* ajuste si tu veux plus/moins court */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

#fsOccTarget{ width:220px; } /* slider raisonnable */


.board.fullscreen{
  position:fixed;
  /* on laisse inset, mais on écrase le top juste après */
  inset:12px;
  left:12px; right:12px; bottom:12px;
  top: calc(var(--topbar-h) + 12px); /* ← évite la barre du haut */
  max-width:none; min-width:unset;
  overflow:auto; z-index:3000;
}

/* Toolbar du dashboard en plein écran */
.fs-toolbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;              /* peut passer à 2 lignes si vraiment pas de place */
}

.fs-left{
  display:flex;
  align-items:center;
  gap:8px;
  flex:1 1 auto;               /* prend la place disponible */
  min-width:340px;             /* évite que “Bâtiment A” se ratatine */
}

.fs-right{
  display:flex;
  align-items:center;
  gap:8px;
  flex:0 0 auto;
  flex-wrap:nowrap;            /* garde slider + bouton sur une seule ligne */
}

.fs-right #fsOccTarget{ width:220px; flex:0 0 220px; }
.fs-right .btn{ flex-shrink:0; }

/* Enlève la petite flèche (bouton icône) près d'“Exporter CSV” s’il existe */
.fs-toolbar .iconbtn{ display:none !important; }

.fs-toolbar .input, .fs-toolbar .select{ height:34px; padding:6px 10px; }

.grid-kpis-4{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px; }
@media (max-width:1200px){ .grid-kpis-4{ grid-template-columns:repeat(2,1fr); } }
@media (max-width:720px){ .grid-kpis-4{ grid-template-columns:1fr; } }

.card.soft{ background:#f8f8f9; border-color:#e5e5ea; }

.table.tight table{ font-size:12px; }
.table.tight .rowlist{ padding:2px 0; }

  
.table{margin-top:8px;max-height:200px;overflow:auto;border:1px solid var(--border);border-radius:12px}
.table table{width:100%;border-collapse:collapse;font-size:12px}
.table th,.table td{padding:6px 8px;border-bottom:1px solid #eee;text-align:left}
.badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:10.5px; border:1px solid var(--border); background:#f8f8f9}
.rowlist{display:grid; grid-template-columns:1fr auto auto; gap:4px; align-items:center; font-size:12px; padding:4px 0; border-bottom:1px dashed #eee}
.rowlist:last-child{border-bottom:0}

/* Legend */
.legend{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
.legend .item{display:flex; align-items:center; gap:4px; font-size:12px; background:#f8f8f9; border:1px solid var(--border); border-radius:999px; padding:4px 8px}
.legend .dot{width:10px; height:10px; border-radius:50%}

/* Color picker — v177 style */
.color-field{display:flex;align-items:center;gap:12px}
.color-pill{width:46px;height:24px;border-radius:999px;border:1px solid var(--border);box-shadow:inset 0 0 0 3px rgba(10,132,255,.12)}
.palette{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.swatch{width:26px;height:26px;border-radius:999px;border:1px solid var(--border);cursor:pointer;box-shadow:inset 0 0 0 2px rgba(255,255,255,.6)}
.swatch.selected{outline:2px solid var(--blue); outline-offset:2px}
#fColor{display:none}

@media (max-width:980px){
  .layout{grid-template-columns:1fr}
  .layout.collapsed{grid-template-columns:1fr}
  aside.panel{position:absolute;z-index:1500;width:min(90vw,380px);inset:70px auto 16px 16px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.15)}
  .drawer-toggle{display:none}
  .board{left:16px;right:16px}
}

.leaflet-control-attribution{display:none !important}

/* Autocomplete dropdown for Nom entreprise (fixed to viewport to survive panel scroll) */
.tenant-field{position:relative}
.suggest{position:absolute;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:6px;display:none;z-index:2000;max-height:240px;overflow:auto;min-width:100%;width:100%}
.suggest .item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px}
.suggest .item:hover,.suggest .item.active{background:#f5f5f7}
.suggest .icon{opacity:.7}

  /* --- Liste modale + boutons compacts --- */
.rowlist.space-item{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:10px 0; border-bottom:1px dashed #eee;
}
.space-item:last-child{ border-bottom:0; }
.space-item .left{
  display:flex; flex-direction:column; gap:4px; min-width:0;
}
.space-item .title{
  font-weight:700; font-size:13px; color:#1c1c1e; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.space-item .meta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.badge.soft{
  background:#f6f6f7; border-color:#e5e5ea; color:#3a3a3c;
}
.btn.pill{
  padding:6px 12px; font-size:12px; border-radius:999px;
}
.btn.pill.ghost{
  background:#fff; border:1px solid var(--border); color:#1c1c1e;
}

/* ----- Board dans le panneau gauche ----- */
body.board-mode aside.panel > *:not(#visitorBoard){
  display: none !important;
}
body.board-mode #visitorBoard{
  display: block !important;
}

/* Style du board quand il vit dans le panneau */
.board.in-panel{
  position:static;
  left:auto; right:auto; top:auto; bottom:auto;
  display:block;
  max-width:none; min-width:unset;
  background:transparent;
  box-shadow:none;
  border:0;
  padding:0;
  z-index:auto;
}
/* ----- Optimisation du board quand il est dans le panneau ----- */
.board.in-panel{
  position: static;
  left: auto; right: auto; top: auto; bottom: auto;
  display: block;
  max-width: none; min-width: unset;
  background: transparent;
  box-shadow: none;
  border: 0;
  padding: 0;
  z-index: auto;
}

/* 1 graphique par ligne (au lieu de 2 colonnes) */
.board.in-panel .grid2{
  grid-template-columns: 1fr;      /* <-- force une seule colonne */
  gap: 12px;
}

/* KPIs sur 2 colonnes (plus lisible dans un panneau étroit) */
.board.in-panel .kpis{
  grid-template-columns: 1fr 1fr;
}
@media (max-width: 420px){
  .board.in-panel .kpis{ grid-template-columns: 1fr; }
}

/* Cartes et paddings adaptés au panneau */
.board.in-panel .card{
  border: 0;
  background: transparent;
  padding: 0;
}
.board.in-panel .canvas-wrap{
  height: 220px;        /* garde une hauteur confortable */
}
.board.in-panel h4{ margin-bottom: 8px; }
/* Positionne les actions quand le board est dans le panneau */
.board.in-panel .board-actions.inpanel{
  position: sticky;
  top: 4px;
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  padding-bottom: 6px;
  z-index: 5;
}

.board.in-panel .board-actions.inpanel .iconbtn{
  width: 30px; height: 30px; font-size: 14px;
  border-radius: 999px;
}


/* ---- UX Date de sortie (préavis) ---- */
.input.date{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  background:#fff; border:1px solid var(--border); border-radius:12px;
  height:42px; padding:0 40px 0 12px; font:inherit; color:var(--text);
  transition:border-color .15s ease, box-shadow .2s ease, background .2s ease;
}
.input.date:hover{ border-color:#d0d0d5; background:#fcfcfd; }
.input.date:focus{ outline:none; border-color:transparent; box-shadow:0 0 0 4px rgba(10,132,255,.15); background:#fff; }
.input.date::-webkit-calendar-picker-indicator{ cursor:pointer; opacity:.85; padding:8px; margin-right:-6px; border-radius:10px; transition: background .15s ease, opacity .15s ease; }
.input.date::-webkit-calendar-picker-indicator:hover{ background:rgba(10,132,255,.08); opacity:1; }
#preavisRow .hint{ font-size:11.5px; color:var(--muted); }

/* Badge tooltip alerte */
.tt-badge{ display:inline-block; padding:1px 6px; border-radius:999px; font-size:10.5px; border:1px solid var(--border); background:#f8f8f9; }
.tt-badge.alert{ border-color:#ffd0d4; background:#ffe9eb; color:#b00020; font-weight:700; }


/* === Custom Apple-like Date Picker (desktop) === */
.datepicker-popover{
  position:absolute; z-index:9999;
  background:#fff; border:1px solid var(--border);
  border-radius:12px; padding:10px 10px 12px 10px;
  box-shadow:0 20px 40px rgba(0,0,0,.14), 0 1px 0 rgba(255,255,255,.6) inset;
  width: 248px;
  user-select:none;
}
.datepicker-popover .dp-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:4px 6px 2px 6px;
}
.dp-title{ font-weight:700; letter-spacing:0.2px; }
.dp-nav{ display:flex; gap:4px; }
.dp-btn{
  border:1px solid var(--border); background:#fafafc; border-radius:10px;
  width:24px; height:24px; display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.dp-btn:hover{ background:#f2f2f6; }
.dp-grid{
  display:grid; grid-template-columns: repeat(7, 1fr);
  gap:4px; padding:6px 8px 0 8px;
}
.dp-weekday{ text-align:center; font-size:10.5px; color:var(--muted); padding:4px 0; }
.dp-day{
  text-align:center; padding:6px 0; border-radius:10px; cursor:pointer;
  border:1px solid transparent; font-weight:600;
}
.dp-day:hover{ background:#f6f7fb; }
.dp-day.today{ outline: 2px solid rgba(10,132,255,.25); outline-offset: 0; border-radius:12px; }
.dp-day.selected{ background:#0a84ff; color:#fff; }
.dp-day.disabled{ color:#c8c8ce; cursor:not-allowed; opacity:.55; }
.dp-footer{
  display:flex; justify-content:space-between; padding:10px 12px 0 12px;
  font-size:12px; color:var(--muted);
}
.dp-link{ cursor:pointer; }
.dp-link:hover{ text-decoration:underline; }
.input.date.has-button{ padding-right: 36px; position: relative; }
.date-open{
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  width:24px; height:24px; border-radius:8px; border:1px solid var(--border);
  background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer;
}
.date-open:hover{ background:#f5f6f8; }
.date-open svg{ width:14px; height:14px; opacity:.7; }
@media (hover:none), (pointer:coarse){
  .date-open{ display:none; } /* Mobile: keep native picker */
}

</style>
</head>
<body class="visitor">
<div class="app">
  <div class="topbar">
    <div class="brand">Épopée — Exploitation</div>
    <div class="hint" id="statusText">Mode visiteur</div>
    <div>
    <button id="btnHistory" class="btn primary">💾 Historique</button>
<!-- Petit panneau d'historique -->
<div id="historyPanel" style="display:none; position:absolute; top:64px; right:16px; z-index:1000; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.08); width:320px; max-height:300px; overflow:auto; padding:8px;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
    <strong>Versions</strong>
    <button id="historyClose" class="btn" aria-label="Fermer">×</button>
  </div>
  <div id="historyList">Chargement…</div>
</div>

      <button class="btn" id="btnAdminBoard">📊 Dashboard</button>
    </div>
  </div>

  <div class="layout" id="layout">
    <aside class="panel" id="leftPanel">
      <h3>Panneau de contrôle</h3>

      <div class="row">
        <div class="field">
          <label>Bâtiment</label>
          <select id="buildingSelect" class="select">
            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="R">R</option>
          </select>
        </div>
        <div class="field">
          <label>Étage</label>
          <select id="floorSelect" class="select"></select>
        </div>
      </div>

      <!-- UI de chargement du plan masquée (plans pré-chargés) -->
      <div class="field" style="display:none">
        <button class="btn" id="btnPlan" title="Passe en mode Admin pour activer">Définir le plan (image/PDF)</button>
        <input type="file" id="planFile" accept="image/*,.pdf" hidden>
        <div id="planHint" class="hint" style="margin-top:6px;">Plan non chargé</div>
      </div>

      <div class="section">
        <h4 style="margin:0 0 6px 0;">Filtres</h4>
        <div class="field"><label>Statuts</label><div id="statusChips" class="chips"></div></div>
<div class="field"><label>Type</label><div id="typeChips" class="chips"></div></div>
        <div class="field"><label>Recherche résident</label><input id="searchInput" class="input" placeholder="Nom, code, libellé…"></div>
      </div>

      <div class="section" id="adminSection">
        <h4 style="margin:0 0 6px 0;">Édition (Admin)</h4>
        <div class="actions">
          <button class="btn" id="btnPoly">Polygone</button>
          <button class="btn" id="btnRect">Rectangle</button>
          <button class="btn" id="btnEditToggle">Édition ON/OFF</button>
        </div>
        <div class="actions" style="margin-top:8px;">
          <button class="btn" id="btnDup">Dupliquer</button>
          <button class="btn" id="btnDelete">Supprimer</button>
        </div>

        <div class="field"><label>Code</label><input id="fCode" class="input" placeholder="ex. A-B7"></div>
        <div class="field tenant-field"><label>Nom entreprise</label><input id="fTenant" class="input" placeholder="ex : Synergie Family"></div>
        <div class="field">
          <label>Libellé</label>
          <select id="fLabel" class="select">
            <option value="Bureau">Bureau</option>
            <option value="Local">Local</option>
            <option value="Terrasse">Terrasse</option>
            <option value="Evenementiel">Evenementiel</option>
          </select>
        </div>
        <div class="field" id="statusField"><label>Statut</label><select id="fStatus" class="select"></select></div>

        <div class="field">
          <label>Couleur</label>
          <div class="color-field">
            <div class="color-pill" id="colorPill" title="Aperçu"></div>
            <input id="fColor" type="color" value="#0a84ff">
          </div>
          <div class="palette" id="colorPalette"></div>
        </div>

        <div class="row3" id="officeRow">
          <div class="field"><label>Surface (m²)</label><input id="fArea" class="number" type="number" min="0" step="0.1" value="0"></div>
          <div class="field"><label>Nombre de postes</label><input id="fPosts" class="number" type="number" min="0" step="1" value="0"></div>
          <div class="field"><label>Loyer (€) / mois</label><input id="fRent" class="number" type="number" min="0" step="1" value="0"></div>
        </div>
        <div class="row3" id="eventRow" style="display:none">
          <div class="field"><label>Nombre de PAX assis</label><input id="fPaxSit" class="number" type="number" min="0" step="1" value="0"></div>
          <div class="field"><label>Nombre de PAX debout</label><input id="fPaxStand" class="number" type="number" min="0" step="1" value="0"></div>
          <div class="field"><label>Prix (€) / jour</label><input id="fDayPrice" class="number" type="number" min="0" step="1" value="0"></div>
        </div>
    

        
<!-- Préavis: visible uniquement si fStatus === "Préavis" et non Événementiel -->
<div class="row3" id="preavisRow" style="display:none">
  <div class="field">
    <label>Date de sortie</label>
    <input id="fExitDate" class="input date" type="date">
  </div>
  <div class="field">
    <label>&nbsp;</label>
    <div class="hint"><span id="exitDateHint">Expire le —</span></div>
  </div>
  <div class="field"><label>&nbsp;</label><div class="hint"></div></div>
</div>
<div class="actions"><button id="btnApply" class="btn primary">Appliquer</button>
      </div>
    </aside>

    <div id="map"></div>

    <div id="visitorBoard" class="board"></div>

    <button id="drawerToggle" class="drawer-toggle" aria-label="Ouvrir/fermer le panneau"><span>‹</span></button>

    <div class="controls-stack">
      <div class="zoom-strip" id="zoomStrip">
        <div class="zoom-btn" id="zoomOut">–</div>
        <div class="zoom-btn" id="zoomIn">+</div>
      </div>
    </div>
  </div>
</div>

<div class="mode-switch" id="modeSwitch">
  <span>Visiteur</span>
  <label class="switch"><input type="checkbox" id="adminToggle"><span class="track"></span><span class="knob"></span></label>
  <span>Admin</span>
</div>

<!-- MODAL PIN -->
<div class="modal" id="padModal" aria-hidden="true">
  <div class="pad" role="dialog" aria-modal="true">
    <h4>Code administrateur</h4>
    <div class="dots" id="pinDots"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    <div class="keygrid" id="keys"></div>
    <div class="hint" id="padError" style="color:#b00020;min-height:18px;margin-top:6px"></div>
  </div>
</div>

<!-- Autocomplete container (now inside the tenant field) -->
<div id="tenantSuggest" class="suggest" role="listbox" aria-label="Suggestions de résidents"></div>

<script>
// ===== Config
const ADMIN_CODE = "1812";
const STATUS_STYLES = {
  "Loué":        { color:"#34c759", fill:"#34c759" },
  "Préavis":     { color:"#5856d6", fill:"#5856d6" },
  "Vacant":      { color:"#ff9f0a", fill:"#ff9f0a" },
  "Réservé":     { color:"#bf5af2", fill:"#bf5af2" },
  "Maintenance": { color:"#ff453a", fill:"#ff453a" }
};
const EVENT_DEFAULT_COLOR = "#ff7ab6"; // Evenementiel
const COLORS = {
  occupied:   STATUS_STYLES["Loué"].fill,
  vacant:     STATUS_STYLES["Vacant"].fill,
  preavis:    STATUS_STYLES["Préavis"].fill,
  reserved:   STATUS_STYLES["Réservé"].fill,
  maintenance:STATUS_STYLES["Maintenance"].fill,
  event:      EVENT_DEFAULT_COLOR
};

function defaultColorFor(ep){
  const lbl = String(ep.label || "")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase();
  if (lbl === "evenementiel") return "#ff7ab6";
  const st = STATUS_STYLES[ep.status || "Vacant"];
  return st ? st.fill : "#0a84ff";
}

const ALL_STATUSES = Object.keys(STATUS_STYLES);
const BUILDING_FLOORS = {
  "A":["RDJ","RDC","R+1","R+2","R+3"],
  "B":["RDC","ENTRE SOL","R+1"],
  "C":["RDC","R+1","R+2"],
  "D":["RDC","R+1"],
  "E":["RDC"],
  "F":["RDC","R+1"],
  "G":["RDC","R+1"],
  "H":["SOUS-SOL","RDC","R+1"],
  "I":["RDC"],
  "R":["RDC","R+1"]
};
const PRELOAD = {
  "A|RDJ":"Bat-A-RDJ.pdf","A|RDC":"Bat-A-RDC.pdf","A|R+1":"Bat-A-R1.pdf","A|R+2":"Bat-A-R2.pdf","A|R+3":"Bat-A-R3.pdf",
  "B|RDC":"Bat-B-RDC.pdf","B|ENTRE SOL":"BAT-B-ENTRE-SOL.pdf","B|R+1":"Bat-B-R1.pdf",
  "C|RDC":"Bat-C-RDC.pdf","C|R+1":"Bat-C-R1.pdf","C|R+2":"Bat-C-R2.pdf",
  "D|RDC":"Bat-D-RDC.pdf","D|R+1":"Bat-D-R1.pdf",
  "E|RDC":"Bat-E-RDC.pdf",
  "F|RDC":"Bat-F-RDC.pdf","F|R+1":"Bat-F-R1.pdf",
  "G|RDC":"Bat-G-RDC.pdf","G|R+1":"Bat-G-R1.pdf",
  "H|SOUS-SOL":"Bat-H-SOUS-SOL.pdf","H|RDC":"Bat-H-RDC.pdf","H|R+1":"Bat-H-R1.pdf",
  "I|RDC":"Bat-I-RDC.pdf",
  "R|RDC":"Bat-R-RDC.pdf","R|R+1":"Bat-R-R1.pdf"
};
const PALETTE = [
  "#0a84ff","#34c759","#ff9f0a","#ff453a","#bf5af2",
  "#64d2ff","#30d158","#ffd60a","#ff375f","#00c7be",
  "#5856d6","#8e8e93","#a2845e","#6c8ef5","#f0932b",
  "#d0021b","#2dce89","#ff7ab6","#7d7aff","#1abc9c"
];

// ===== State
let map, baseImageLayer;
let drawn = L.featureGroup();
let currentLayer = null;
let isAdmin = false;
let activeStatuses = new Set(ALL_STATUSES);
let searchText = "";
let currentKey = "";
let filterEventOnly = false; // tout afficher par défaut


// ===== Helpers
const $ = (id)=>document.getElementById(id);
const keyFor = (b,f)=>`${b}|${f}`;
const storageKey = (k)=>`epopee_plans_v177_${k}`;
const loadFromCache = (k)=>{
  try{ return JSON.parse(localStorage.getItem(storageKey(k))||"null"); }
  catch(e){ return null; }
};

// ===== Map
map = L.map("map", { crs: L.CRS.Simple, zoomControl:false, minZoom:-4, maxZoom:4, zoomSnap:0.1, zoomDelta:0.5, inertia:true });
drawn.addTo(map);
$("zoomIn").onclick=()=> map.zoomIn();
$("zoomOut").onclick=()=> map.zoomOut();

// Geoman toolbar
map.pm.addControls({
  position: 'topright',
  drawMarker: false,
  drawCircle: false,
  drawPolyline: false,
  drawCircleMarker: false,
  drawRectangle: true,
  drawPolygon: true,
  editMode: true,
  dragMode: false,
  removalMode: true,
  cutPolygon: false
});
map.off('pm:remove');
map.on('pm:remove', (e) => {
  try {
    const l = e && e.layer;
    if (l && drawn && drawn.hasLayer && drawn.hasLayer(l)) drawn.removeLayer(l);
  } catch (_) {}
  setTimeout(() => { saveLocal(); }, 0);
});
map.pm.setLang('fr');
map.pm.setPathOptions({ snappable:true, snapDistance:10 });

// ===== Styling & data helpers
function layerProps(l){ return l?.options?.ep || {}; }
function setLayerProps(l, props){ l.options.ep = { ...(l.options.ep||{}), ...props }; applyStyle(l); }
function normalStyleFor(l){
  const ep = layerProps(l);
  const isEvent = String(ep.label||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase() === "evenementiel";
  const fill = isEvent ? "#ff7ab6" : (ep.color || (STATUS_STYLES[ep.status || "Vacant"]?.fill || "#0a84ff"));
  return { color: fill, opacity:1, fillColor: fill, fillOpacity:.35, weight:2 };
}
function greyStyle(){ return { color:"#8e8e93", opacity:1, fillColor:"#b1b2b5", fillOpacity:.35, weight:1 }; }
function applyStyle(l){
  l.setStyle(normalStyleFor(l));
  const ep = layerProps(l);
  const isEvent = (ep.label === "Evenementiel");
  let extra = "";
  if (isEvent){
    if(ep.paxSit)   extra += ` · ${ep.paxSit} pax assis`;
    if(ep.paxStand) extra += ` · ${ep.paxStand} pax debout`;
    if(Number(ep.dayPrice)>0) extra += ` · ${Number(ep.dayPrice).toLocaleString('fr-FR')} €/jour`;
  } else {
    if(ep.posts) extra += ` · ${ep.posts} postes`;
    if(Number(ep.rent)>0) extra += ` · ${euro(ep.rent)} €/mois`;
  }
  if(ep.area) extra += ` · ${ep.area} m²`;
    // Badge délai de sortie si Préavis
  try{
    const ep = layerProps(l);
    if (ep.status === "Préavis" && ep.exitDate){
      const d = new Date(ep.exitDate + "T00:00:00");
      const t = new Date(); t.setHours(0,0,0,0);
      const diff = Math.round((d - t)/(1000*60*60*24));
      if (!isNaN(diff)){
        if (diff >= 0) extra += ` · <span class="tt-badge">⏳ ${diff} j</span>`;
        else           extra += ` · <span class="tt-badge alert">⏳ ${Math.abs(diff)} j dépassé</span>`;
      }
    }
  }catch(_){}
  l.bindTooltip(`${(ep.code||"—")} · ${(ep.label||"Bureau")}${ep.tenant ? " — "+ep.tenant : ""}${extra}`, { sticky:true });
  updateGreying();
}
function toPlain(l){
  if (l instanceof L.Rectangle) {
    const b = l.getBounds();
    return { type: 'rect', bounds: [ b.getSouthWest(), b.getNorthEast() ], options: { ep: layerProps(l) } };
  }
  return { type: 'poly', latlngs: l.getLatLngs(), options: { ep: layerProps(l) } };
}
function fromPlain(o){
  let l;
  if (o.type === 'rect') {
    let bounds = o.bounds;
    if (!bounds && Array.isArray(o.latlngs)) {
      const pts = (o.latlngs[0] || o.latlngs).flat();
      const lats = pts.map(p=>p.lat), lngs = pts.map(p=>p.lng);
      bounds = [ L.latLng(Math.min(...lats), Math.min(...lngs)), L.latLng(Math.max(...lats), Math.max(...lngs)) ];
    }
    l = L.rectangle(bounds, { pmIgnore:false });
  } else {
    l = L.polygon(o.latlngs, { pmIgnore:false });
  }
  l.options.ep = (o.options && o.options.ep) || {};
  l.addTo(drawn); attachListeners(l); applyStyle(l);
}
function exportGeo(){ return { key: currentKey, features: drawn.getLayers().map(toPlain) }; }
function importGeo(data){ drawn.clearLayers(); (data?.features||[]).forEach(fromPlain); }

async function saveLocal(){
  localStorage.setItem(storageKey(currentKey), JSON.stringify(exportGeo()));
  try{
    const token = sessionStorage.getItem('ADMIN_TOKEN') || "";
    const data = exportGeo();
    const [building, floor] = currentKey.split("|");
    await fetch("/api/spaces/batch", {
      method: "POST",
      headers: { "content-type":"application/json", ...(token ? { "authorization": "Bearer " + token } : {}) },
      body: JSON.stringify({ building, floor, features: data.features })
    });
    $("statusText").textContent = "Sauvegardé sur la base ✅";
    setTimeout(()=> $("statusText").textContent = isAdmin ? "Mode admin" : "Mode visiteur", 900);
  }catch(e){
    console.warn("Sync distant KO → local OK", e);
    $("statusText").textContent = "Sauvegardé en local (offline) ☁️";
    setTimeout(()=> $("statusText").textContent = isAdmin ? "Mode admin" : "Mode visiteur", 1200);
  }
  updateBoard && updateBoard();
}

async function loadLocal(k){
  try{
    const [building, floor] = k.split("|");
    const res = await fetch(`/api/spaces?building=${encodeURIComponent(building)}&floor=${encodeURIComponent(floor)}`);
    if(res.ok){
      const { items } = await res.json();
      const features = (items||[]).map(row => row.geom);
      const payload = { key:k, features };
      localStorage.setItem(storageKey(k), JSON.stringify(payload));
      return payload;
    }
  }catch(e){ console.warn("Lecture distante KO → fallback local", e); }
  try{ return JSON.parse(localStorage.getItem(storageKey(k))||"null"); }
  catch(e){ return null; }
}

function setLabelValue(val){
  const sel = $("fLabel"); if(!sel) return;
  let found = [...sel.options].some(o=> o.value===val);
  if(!found && val){ const o=document.createElement('option'); o.value=val; o.textContent=val; sel.appendChild(o); }
  sel.value = val || "Bureau";
}

  function isEventLabel(lbl){
  return String(lbl||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .trim().toLowerCase() === "evenementiel";
}

// Event UI
function syncEventUI(){
  const isEvent = ($("fLabel").value === "Evenementiel");
  if (currentLayer) setLayerProps(currentLayer, { label: $("fLabel").value });
  $("statusField").style.display = isEvent ? "none" : "block";
  $("officeRow").style.display  = isEvent ? "none" : "grid";
  $("eventRow").style.display   = isEvent ? "grid" : "none";
  if (currentLayer) {
    if (isEvent) setColor("#ff7ab6");
    else {
      const st = layerProps(currentLayer).status || "Vacant";
      setColor(layerProps(currentLayer).color || STATUS_STYLES[st].fill);
    }
  }
  // Affichage du bloc préavis (statut=Préavis, non événementiel)
  try{
    const isEvent = (document.getElementById("fLabel").value === "Evenementiel");
    const showPreavis = !isEvent && (document.getElementById("fStatus").value === "Préavis");
    const pr = document.getElementById("preavisRow"); if (pr) pr.style.display = showPreavis ? "grid" : "none";
  }catch(_){}

}
$("fLabel").addEventListener("change", syncEventUI);

// Select helper
function selectLayer(l, focusFirst=true){
  if(!l) return;
  currentLayer = l;
  const ep = layerProps(l);
  $("fCode").value = ep.code||"";
  $("fTenant").value = ep.tenant||"";
  setLabelValue(ep.label || "Bureau");
  $("fStatus").value = ep.status||"Vacant";
  setColor(ep.color || defaultColorFor(ep));
  $("fArea").value = ep.area||0;
  $("fPosts").value = ep.posts||0;
  $("fRent").value = ep.rent||0;
  $("fPaxSit") && ($("fPaxSit").value = ep.paxSit||0);
  $("fPaxStand") && ($("fPaxStand").value = ep.paxStand||0);
  $("fDayPrice") && ($("fDayPrice").value = ep.dayPrice||0);
  syncEventUI && syncEventUI();
  if(isAdmin){ $("layout").classList.remove("collapsed"); }
  if(focusFirst){ setTimeout(()=> $("fCode").focus(), 0); }
  $("colorPill").animate(
    [{boxShadow:'inset 0 0 0 3px rgba(10,132,255,.12)'},{boxShadow:'inset 0 0 0 8px rgba(10,132,255,.2)'},{boxShadow:'inset 0 0 0 3px rgba(10,132,255,.12)'}],
    {duration:600}
  );
  // Date de sortie (si présente)
  try{ const d=document.getElementById("fExitDate"); if(d) d.value = (layerProps(l).exitDate || ""); }catch(_){}
  // Visibilité bloc préavis
  try{
    const isEvent = (document.getElementById("fLabel").value === "Evenementiel");
    const showPreavis = !isEvent && (document.getElementById("fStatus").value === "Préavis");
    const pr = document.getElementById("preavisRow"); if (pr) pr.style.display = showPreavis ? "grid" : "none";
  }catch(_){}

}

// interactions
map.on('pm:create', e=>{
  const l=e.layer.addTo(drawn);
  setLayerProps(l,{status:"Vacant",label:"Bureau"});
  attachListeners(l);
  selectLayer(l, true);
  saveLocal();
});
map.on('pm:edit', ()=>{ saveLocal(); });
function attachListeners(l){ l.on('click', ()=>{ if(!isAdmin) return; selectLayer(l, false); }); }

// Left panel actions
$("btnPoly").onclick = ()=>{ if(!isAdmin) return; map.pm.enableDraw('Polygon'); };
$("btnRect").onclick = ()=>{ if(!isAdmin) return; map.pm.enableDraw('Rectangle'); };
$("btnEditToggle").onclick = ()=>{
  if(!isAdmin) return;
  if(map.pm.globalEditModeEnabled()){ map.pm.disableGlobalEditMode(); }
  else { map.pm.enableGlobalEditMode(); }
};

// Color selector
const colorPill = $("colorPill"), colorInput = $("fColor"), paletteEl = $("colorPalette");
function setColor(val){
  colorInput.value=val; colorPill.style.backgroundColor = val;
  [...paletteEl.querySelectorAll('.swatch')].forEach(s=> s.classList.toggle('selected', s.dataset.color===val));
  if(currentLayer){ currentLayer.setStyle({fillColor:val, color:val}); }
}
function buildPalette(){
  paletteEl.innerHTML="";
  PALETTE.forEach(hex=>{
    const d=document.createElement('button');
    d.type="button"; d.className="swatch"; d.style.background=hex; d.dataset.color=hex; d.title=hex;
    d.onclick=()=> setColor(hex);
    paletteEl.appendChild(d);
  });
}
buildPalette();
colorInput.oninput = ()=> setColor(colorInput.value);

$("fStatus").addEventListener('change', ()=>{
  if(!currentLayer) return;
  const ep = layerProps(currentLayer);

// toggle preavisRow on status change (non-destructif)
document.getElementById("fStatus").addEventListener('change', function(){
  try{
    const isEvent = (document.getElementById("fLabel").value === "Evenementiel");
    const showPreavis = !isEvent && (this.value === "Préavis");
    const pr = document.getElementById("preavisRow"); if (pr) pr.style.display = showPreavis ? "grid" : "none";
  }catch(_){}
});

  const prevDefault = STATUS_STYLES[ep.status||"Vacant"].fill;
  if(!ep.color || ep.color === prevDefault){
    const hex = STATUS_STYLES[$("fStatus").value].fill;
    setColor(hex);
  } else { setColor(ep.color); }
});

$("btnApply").onclick = ()=>{
  if(!currentLayer) return;
  const __isEvent = ($("fLabel").value === "Evenementiel");
  setLayerProps(currentLayer, {
    code:$("fCode").value.trim(), tenant:$("fTenant").value.trim(), label:$("fLabel").value,
    status: __isEvent ? "Réservé" : $("fStatus").value, color:colorInput.value, area: parseFloat($("fArea").value||"0")||0,
    posts: __isEvent ? 0 : (parseInt(($("fPosts").value||"0"),10)||0),
    rent: __isEvent ? 0 : (parseFloat(String($("fRent").value||"0").replace(",", "."))||0),
    paxSit: __isEvent ? (parseInt(($("fPaxSit")?.value||"0"),10)||0) : 0,
    paxStand: __isEvent ? (parseInt(($("fPaxStand")?.value||"0"),10)||0) : 0,
    dayPrice: __isEvent ? (parseFloat(String($("fDayPrice")?.value||"0").replace(",", "."))||0) : 0
    ,exitDate: ((document.getElementById("fLabel").value === "Evenementiel") ? "" : (document.getElementById("fStatus").value==="Préavis" ? (document.getElementById("fExitDate").value||"") : ""))
});
  saveLocal();
  const b=$("btnApply"); const orig=b.textContent;
  b.textContent="Appliqué ✓"; b.classList.add("success","flash");
  setTimeout(()=>{ b.textContent=orig; b.classList.remove("success","flash"); }, 900);
};

$("btnDelete").onclick = ()=>{ if(currentLayer){ drawn.removeLayer(currentLayer); currentLayer=null; saveLocal(); } };
$("btnDup").onclick = ()=>{ if(!currentLayer) return; const p=toPlain(currentLayer); p.latlngs=p.latlngs.map(r=> r.map(ll=> L.latLng(ll.lat+20,ll.lng+20))); fromPlain(p); saveLocal(); };

// Plan loading
const planFile = $("planFile");
$("btnPlan") && ($("btnPlan").onclick = ()=> { if(isAdmin) planFile.click(); });
planFile && (planFile.onchange = async (e)=>{ const file=e.target.files[0]; if(!file) return; await loadPlanFromFile(file); });
async function loadPlanFromFile(file){
  if(file.type==="application/pdf"){
    const url = URL.createObjectURL(file);
    const pdf = await pdfjsLib.getDocument(url).promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({scale:2});
    const c = document.createElement('canvas'); const ctx=c.getContext('2d');
    c.width = viewport.width; c.height = viewport.height;
    await page.render({canvasContext:ctx, viewport}).promise;
    setBaseImage(c.toDataURL('image/png'), [c.height, c.width]);
    $("planHint").textContent = `${file.name} (page 1)`;
  }else{
    const reader = new FileReader();
    reader.onload = ()=>{ const img=new Image(); img.onload=()=> setBaseImage(reader.result,[img.naturalHeight,img.naturalWidth]); img.src=reader.result; };
    reader.readAsDataURL(file); $("planHint").textContent = file.name;
  }
}

// Preload
async function tryPreload(b,f){
  const url = PRELOAD[keyFor(b,f)];
  if(!url){ placeholder(b,f); return; }
  try{
    if(url.toLowerCase().endsWith(".pdf")){
      const pdf = await pdfjsLib.getDocument(url).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({scale:2});
      const c = document.createElement('canvas'); const ctx=c.getContext('2d');
      c.width = viewport.width; c.height = viewport.height;
      await page.render({canvasContext:ctx, viewport}).promise;
      setBaseImage(c.toDataURL('image/png'), [c.height, c.width]);
    }else{
      await new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>{ setBaseImage(url,[img.naturalHeight,img.naturalWidth]); res(); }; img.onerror=rej; img.src=url; });
    }
    $("planHint").textContent = url;
  }catch(err){
    console.warn("Préchargement échoué:", err);
    $("planHint").textContent = 'Plan introuvable. Placez les fichiers PDF à côté du HTML ou utilisez "Définir le plan".';
    placeholder(b,f);
  }
}
function placeholder(b,f){
  const w=2480, h=1754; const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h); ctx.strokeStyle="#e5e5ea";
  for(let x=0;x<w;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
  for(let y=0;y<h;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
  ctx.fillStyle="#1c1c1e"; ctx.font="bold 28px Inter, system-ui, -apple-system"; ctx.fillText(`${b} ${f}`, 24, 48);
  setBaseImage(c.toDataURL("image/png"), [h,w]);
}
function setBaseImage(src, dim){
  if(baseImageLayer){ map.removeLayer(baseImageLayer); }
  const h=dim[0], w=dim[1]; const bounds=[[0,0],[h,w]];
  baseImageLayer = L.imageOverlay(src, bounds).addTo(map);
  map.fitBounds(bounds, {padding:[20,20]});
  wireBoardActions();
}
  
function rebuildStatusChips(){
  const wrap = $("statusChips"); if(!wrap) return;
  wrap.innerHTML = "";
  ALL_STATUSES.forEach(s=>{
    const id = "chip_status_" + s;
    const lab = document.createElement("label");
    lab.className = "chip";
    lab.innerHTML = `<input type="checkbox" id="${id}" checked> ${s}`;
    wrap.appendChild(lab);

    const chk = $(id);
    chk.onchange = (e)=>{
      if(e.target.checked) activeStatuses.add(s);
      else activeStatuses.delete(s);
      updateGreying();
    };
  });
}
  
function rebuildTypeChips(){
  const wrap = $("typeChips"); if(!wrap) return;
  wrap.innerHTML="";
  const id="chip_event_type";
  const lab=document.createElement("label"); lab.className="chip";
  lab.innerHTML=`<input type="checkbox" id="${id}" checked> Événementiel`;
  wrap.appendChild(lab);

  const chk = $(id);
  // Sync immédiat de l’état global avec la case déjà cochée
  filterEventOnly = !chk.checked;      // -> false puisque cochée
  chk.onchange = (e)=>{ filterEventOnly = !e.target.checked; updateGreying(); };
}

  function ensureFilters(){
  rebuildStatusChips();
  rebuildTypeChips();
  updateGreying();
}

  function updateGreying(){
  drawn.getLayers().forEach(l=>{
    const ep = layerProps(l);
    const matches = activeStatuses.has(ep.status || "Vacant");
    const text = `${ep.code||""} ${ep.label||""} ${ep.tenant||""}`.toLowerCase();
    const matchText = !searchText || text.includes(searchText);
    const isEvent = isEventLabel(ep.label);
    const typeOk = !filterEventOnly || isEvent; // décoché => filterEventOnly=true => événementiel uniquement
    const ok = matches && matchText && typeOk;
    l.setStyle(ok ? normalStyleFor(l) : greyStyle());
  });
}


// ===== Visitor/Admin
const padModal=$("padModal"), pinDots=$("pinDots").querySelectorAll('.dot'), keysGrid=$("keys");
let pin=""; function openPad(){ pin=""; syncPad(); padModal.classList.add('open'); keysGrid.querySelector('[data-key="1"]')?.focus(); }
function closePad(){ padModal.classList.remove('open'); }
function syncPad(){ pinDots.forEach((d,i)=> d.classList.toggle('active', i<pin.length)); const okBtn=keysGrid.querySelector('[data-role="ok"]'); if(okBtn){ okBtn.toggleAttribute('disabled', pin.length!==4); } $("padError").textContent=""; }
(function buildPad(){
  const layout = ['1','2','3','4','5','6','7','8','9','back','0','ok'];
  keysGrid.innerHTML="";
  layout.forEach(key=>{
    const b = document.createElement('button');
    b.type="button"; b.className="key"; b.tabIndex=0;
    if(key==='back'){ b.classList.add('icon'); b.setAttribute('aria-label','Effacer'); b.dataset.key='back'; b.innerHTML='⌫'; b.onclick=()=>{ if(pin.length){ pin=pin.slice(0,-1); syncPad(); } }; }
    else if(key==='ok'){ b.classList.add('primary'); b.dataset.role='ok'; b.dataset.key='ok'; b.textContent='Valider'; b.disabled=true; b.onclick=()=>{ if(pin===ADMIN_CODE){ isAdmin=true; closePad(); $("adminToggle").checked=true; syncMode(); } else { $("padError").textContent="Code incorrect"; } }; }
    else { b.dataset.key=key; b.textContent=key; b.onclick=()=>{ if(pin.length<4){ pin+=key; syncPad(); } }; }
    keysGrid.appendChild(b);
  });
})();
document.addEventListener('keydown', (e) => {
  const isPadOpen = padModal.classList.contains('open'); if (!isPadOpen) return;
  const k = e.key;
  if (/^[0-9]$/.test(k)) { e.preventDefault(); if (pin.length < 4) { pin += k; syncPad(); } return; }
  if (k === 'Backspace' || k === 'Delete') { e.preventDefault(); pin = pin.slice(0, -1); syncPad(); return; }
  if (k === 'Enter' || e.code === 'NumpadEnter') { e.preventDefault(); const okBtn = keysGrid.querySelector('[data-role="ok"]'); if (okBtn && !okBtn.disabled) okBtn.click(); return; }
  if (k === 'Escape') { e.preventDefault(); closePad(); if (!isAdmin) { $("adminToggle").checked = false; } return; }
});
padModal.addEventListener('click', (e)=>{ if(e.target===padModal){ closePad(); if(!isAdmin){ $("adminToggle").checked=false; } } });

$("adminToggle").checked=false;
$("adminToggle").onchange = e=>{ if(e.target.checked){ if(!isAdmin) openPad(); else syncMode(); } else { isAdmin=false; syncMode(); } };

function mountGeoman(){
  if (!document.querySelector('.leaflet-pm-toolbar')){
    map.pm.addControls({ position:'topright', drawMarker:false, drawCircle:false, drawPolyline:false, drawCircleMarker:false, drawRectangle:true, drawPolygon:true, editMode:true, dragMode:false, removalMode:true, cutPolygon:false });
    map.pm.setLang('fr'); map.pm.setPathOptions({ snappable:true, snapDistance:10 });
  }
  const bar = document.querySelector('.leaflet-pm-toolbar');
  if (bar){
    bar.style.top = '128px'; bar.style.right = '16px'; bar.style.transform = 'none'; bar.style.zIndex = '1400';
    bar.style.display = isAdmin ? '' : 'none';
  }
}
function syncMode(){
  $("statusText").textContent = isAdmin ? "Mode admin" : "Mode visiteur";
 const showEdition = isAdmin && !document.body.classList.contains("board-mode");
$("adminSection").style.display = showEdition ? "block" : "none";
  $("btnPlan") && ($("btnPlan").disabled = !isAdmin);
  document.body.classList.toggle('visitor', !isAdmin);
  document.body.classList.toggle('admin', isAdmin);
  if (isAdmin){ $("layout").classList.remove("collapsed"); }
  else {
    $("layout").classList.remove("collapsed");
    map.pm.disableGlobalEditMode();
    map.pm.disableGlobalRemovalMode && map.pm.disableGlobalRemovalMode();
    map.pm.disableDraw('Polygon'); map.pm.disableDraw('Rectangle');
    drawn.eachLayer(l=>{ if(l.pm && l.pm.disable){ l.pm.disable(); } });
    currentLayer = null;
  }
  mountGeoman();
}
syncMode();
// ⌦ Hotkey: Delete/Backspace pour supprimer la forme sélectionnée
let __wiredDeleteHotkey = false;
function wireDeleteHotkey(){
  if (__wiredDeleteHotkey) return;
  __wiredDeleteHotkey = true;

  document.addEventListener('keydown', (e) => {
    if (!isAdmin) return;                             // seulement en mode admin
    if (padModal && padModal.classList.contains('open')) return; // pas quand le PIN est ouvert
    if (e.key !== 'Delete' && e.key !== 'Backspace') return;

    // ne pas intercepter quand on tape dans un champ
    const a = document.activeElement;
    if (a && (a.tagName === 'INPUT' || a.tagName === 'TEXTAREA' || a.isContentEditable)) return;

    if (currentLayer){
      e.preventDefault();           // évite "page précédente" avec Backspace
      drawn.removeLayer(currentLayer);
      currentLayer = null;
      saveLocal();
    }
  });
}
document.addEventListener('DOMContentLoaded', wireDeleteHotkey);
// (tu peux aussi simplement appeler wireDeleteHotkey(); ici, ça marche pareil)

// Drawer
document.getElementById("drawerToggle").onclick = ()=>{ document.getElementById("layout").classList.toggle("collapsed"); };

// Building/floor
const buildingSelect=$("buildingSelect"), floorSelect=$("floorSelect");
function buildFloorOptions(b){ floorSelect.innerHTML=""; (BUILDING_FLOORS[b]||[]).forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; floorSelect.appendChild(o); }); }
async function onKeyChange(){
  const b = buildingSelect.value, f = floorSelect.value;
  currentKey = keyFor(b,f);
  const data = await loadLocal(currentKey);
  ensureFilters(); // reconstruit les puces après le preload + import
  importGeo(data || loadFromCache(currentKey) || { features: [] });
  await tryPreload(b,f);
  updateBoard();
}
buildingSelect.onchange = async ()=>{ buildFloorOptions(buildingSelect.value); await onKeyChange(); };
floorSelect.onchange = onKeyChange;

document.addEventListener('DOMContentLoaded', async () => {
  buildFloorOptions("A"); buildingSelect.value = "A"; floorSelect.value = "RDJ";
  await onKeyChange();
  rebuildStatusChips(); rebuildTypeChips();
  function fillStatusSelect(){
    const sel = $("fStatus"); sel.innerHTML = "";
    ALL_STATUSES.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  }
  fillStatusSelect(); syncEventUI && syncEventUI();
});

// Dashboard dans le panneau de gauche (visiteur & admin)
$("btnAdminBoard").onclick = ()=>{
  const b = $("visitorBoard");
  const left = $("leftPanel");

  // Bascule du mode
  const activating = !document.body.classList.contains("board-mode");
  document.body.classList.toggle("board-mode", activating);
  $("adminSection").style.display = "none";

  if (activating){
    // Place le board DANS le panneau gauche
    if (b.parentElement !== left) left.appendChild(b);
    b.classList.remove("fullscreen");
    b.classList.add("in-panel");
    b.style.display = "block";
    renderDashboard();
    wireBoardActions();
  } else {
    // Cache le board et revient au panneau d’édition
    b.classList.remove("in-panel","fullscreen");
    b.style.display = "none";
    // ✅ ré-affiche l’édition si on quitte le dashboard
    $("adminSection").style.display =
      (isAdmin && !document.body.classList.contains("board-mode")) ? "block" : "none";
  }
};


function euro(n){ const v=Number(n||0); const hasCents=Math.abs(v-Math.round(v))>1e-6; return v.toLocaleString('fr-FR',{minimumFractionDigits:hasCents?2:0, maximumFractionDigits:2}); }

function wireBoardActions(){
  const b       = $("visitorBoard");
  const backBtn = $("boardBack");
  const popBtn  = $("boardPop");
  const closeBtn= $("boardClose");
  const minBtn  = $("boardMin");

  // ← Revenir à l’édition
  if (backBtn && !backBtn.__wired){
    backBtn.__wired = true;
    backBtn.onclick = () => {
      document.body.classList.remove('dashboard-fullscreen');
      // Si le board est dans le panneau, on simule le bouton Dashboard pour quitter
      if (document.body.classList.contains("board-mode")) {
        $("btnAdminBoard")?.click();
      } else {
        b.classList.remove("fullscreen");
        b.style.display = "none";
      }
      $("adminSection").style.display =
        (isAdmin && !document.body.classList.contains("board-mode")) ? "block" : "none";
    };
  }

  // ↗ Plein écran
  if (popBtn && !popBtn.__wired){
    popBtn.__wired = true;
    popBtn.onclick = () => {
      document.body.classList.add('dashboard-fullscreen');
      // Sors le board du panneau si besoin
      const left = $("leftPanel");
      if (b.parentElement === left) document.body.classList.remove("board-mode");
      b.classList.remove("in-panel");
      b.classList.add("fullscreen");
      b.style.display = "block";
      renderDashboard();
      wireBoardActions();
    };
  }

  // ⤢ Réduire
  if (minBtn && !minBtn.__wired){
    minBtn.__wired = true;
    minBtn.onclick = () => {
      document.body.classList.remove('dashboard-fullscreen');
      b.classList.remove("fullscreen");
      if (document.body.classList.contains("board-mode")){
        const left = $("leftPanel");
        if (b.parentElement !== left) left.appendChild(b);
        b.classList.add("in-panel");
        b.style.display = "block";
        renderDashboard();
      } else {
        b.style.display = "none";
      }
    };
  }

  // ✕ Fermer
  if (closeBtn && !closeBtn.__wired){
    closeBtn.__wired = true;
    closeBtn.onclick = () => {
      document.body.classList.remove('dashboard-fullscreen');
      b.style.display = "none";
      b.classList.remove("fullscreen","in-panel");
      document.body.classList.remove("board-mode");
      $("layout").classList.remove("collapsed");
      $("adminSection").style.display =
        (isAdmin && !document.body.classList.contains("board-mode")) ? "block" : "none";
    };
  }
}

// ===== Dashboard computations & charts
function getFeaturesForScope(scope){
  const all = [];
  const curB = buildingSelect.value;
  const curF = floorSelect.value;
  const curKey = keyFor(curB, curF);

  const isBuildingCode = !!BUILDING_FLOORS[scope];       // "A".."R" ?
  const targetB = isBuildingCode ? scope : curB;         // bâtiment demandé ou courant

  function pushFromStore(k){
    if (k === curKey) {
      exportGeo().features.forEach(fe => all.push(fe));
    } else {
      const st = loadFromCache(k);
      if (st && st.features) st.features.forEach(fe => all.push(fe));
    }
  }

  if (scope === "all"){
    Object.keys(BUILDING_FLOORS).forEach(b =>
      (BUILDING_FLOORS[b]||[]).forEach(f => pushFromStore(keyFor(b,f)))
    );
  } else if (isBuildingCode || scope === "building"){
    (BUILDING_FLOORS[targetB] || []).forEach(f => pushFromStore(keyFor(targetB, f)));
  } else {
    // fallback = seulement l'étage courant
    exportGeo().features.forEach(fe => all.push(fe));
  }
  return all;
}

function aggStats(features){
  const total = features.length;

  const counts = { Loué:0, Vacant:0, Préavis:0, Réservé:0, Maintenance:0 };
  const area   = { Loué:0, Vacant:0, Préavis:0, Réservé:0, Maintenance:0 };
  const posts  = { Loué:0, Vacant:0, Préavis:0, Réservé:0, Maintenance:0 };
  const rent   = { Loué:0, Vacant:0, Préavis:0, Réservé:0, Maintenance:0 };

  const byTenant = {};
  const reservedList = [];
  let reservedRentNonEvent = 0;

  features.forEach(fe=>{
    const ep = (fe.options && fe.options.ep) || {};
    const st = ep.status || "Vacant";
    const isEvent = (ep.label === "Evenementiel");

    const ar       = Number(ep.area||0);
    const postsVal = parseInt(ep.posts||0,10) || 0;
    const rentVal  = parseFloat(String(ep.rent||0).toString().replace(",", ".")) || 0;

    counts[st] = (counts[st]||0)+1;
    area[st]   = (area[st]  ||0)+ar;
    posts[st]  = (posts[st] ||0)+postsVal;
    rent[st]   = (rent[st]  ||0)+rentVal;

    const tenant = (ep.tenant||"").trim();
    if(tenant && tenant.toLowerCase()!=="vacant"){
      if(!byTenant[tenant]) byTenant[tenant]={count:0, area:0, posts:0, rent:0};
      byTenant[tenant].count += 1;
      byTenant[tenant].area  += ar;
      byTenant[tenant].posts += postsVal;
      byTenant[tenant].rent  += rentVal;
    }

    if(st === "Réservé" && !isEvent){
      reservedList.push({code: ep.code||"—", label: ep.label||"Bureau", area: ar});
      reservedRentNonEvent += rentVal;
    }
  });

  const occupiedCount = (counts["Loué"]||0) + (counts["Préavis"]||0);
  const vacantCount   = (counts["Vacant"]||0);
  const occupiedPct   = total? Math.round(occupiedCount*1000/total)/10 : 0;
  const vacantPct     = total? Math.round(vacantCount*1000/total)/10 : 0;

  const tenantsArr = Object.entries(byTenant).map(([k,v])=>({tenant:k, ...v}))
    .sort((a,b)=> b.count - a.count).slice(0,5);
  const tenantsAreaArr = Object.entries(byTenant).map(([k,v])=>({tenant:k, ...v}))
    .sort((a,b)=> b.area - a.area).slice(0,5);
  const tenantsRentArr = Object.entries(byTenant).map(([k,v])=>({tenant:k, ...v}))
    .sort((a,b)=> (b.rent||0) - (a.rent||0)).slice(0,5);

  const areaOcc = (area["Loué"]||0) + (area["Préavis"]||0);
  const areaVac = (area["Vacant"]||0);

  const totalPosts = Object.values(posts).reduce((a,b)=>a+b,0);
  const occPosts   = (posts["Loué"]||0) + (posts["Préavis"]||0);
  const vacPosts   = Math.max(0, totalPosts - occPosts);

  const rentFacture   = (rent["Loué"]||0) + (rent["Préavis"]||0);
  const rentPotentiel = rentFacture + reservedRentNonEvent;
  const rentTotal     = Object.values(rent).reduce((a,b)=>a+b,0);
  const euroPerPost   = totalPosts ? (rentFacture / totalPosts) : 0;

  return {
    totalSpaces: total, counts, area, posts, rent,
    occupiedCount, vacantCount, occupiedPct, vacantPct,
    tenantsArr, tenantsAreaArr, tenantsRentArr,
    areaOcc, areaVac, totalPosts, occPosts, vacPosts,
    rentFacture, rentPotentiel, rentTotal, euroPerPost,
    reservedList
  };
}

// (indépendant) — parcourt les clés b|f sur une portée donnée
function forEachKeyInScope(scope, fn){
  const curB = buildingSelect.value, curF = floorSelect.value;
  const curKey = keyFor(curB,curF);
  const isBuildingCode = !!BUILDING_FLOORS[scope];
  const targetB = isBuildingCode ? scope : curB;

  function push(k){
    const store = (k===curKey) ? exportGeo() : loadFromCache(k);
    const feats = (store && store.features) || [];
    fn(k, feats);
  }

  if (scope==="all"){
    Object.keys(BUILDING_FLOORS).forEach(b =>
      (BUILDING_FLOORS[b]||[]).forEach(f => push(keyFor(b,f)))
    );
  } else if (isBuildingCode || scope==="building"){
    (BUILDING_FLOORS[targetB]||[]).forEach(f => push(keyFor(targetB,f)));
  } else {
    push(curKey);
  }
}

// (indépendant) — taux d’occupation par étage (en m²)
function floorsStats(scope){
  const mapRates = new Map();
  forEachKeyInScope(scope,(k,feats)=>{
    const [b,f]=k.split("|");
    let tot=0, occ=0;
    feats.forEach(fe=>{
      const ep = (fe.options && fe.options.ep) || {};
      const isEvent = (ep.label === "Evenementiel");
      const typeOk  = !filterEventOnly || isEvent;
      const matches = activeStatuses.has(ep.status || "Vacant");
      const text = `${ep.code||""} ${ep.label||""} ${ep.tenant||""}`.toLowerCase();
      const matchText = !searchText || text.includes(searchText);
      if(!typeOk || !matches || !matchText) return;
      const ar = Number(ep.area||0);
      tot += ar;
      if (ep.status==="Loué" || ep.status==="Préavis") occ += ar;
    });
    const o = mapRates.get(k) || {b,f,occArea:0,totArea:0};
    o.occArea += occ; o.totArea += tot;
    mapRates.set(k,o);
  });
  return [...mapRates.values()].map(o => ({
    ...o,
    rate: o.totArea ? Math.round(o.occArea*1000/o.totArea)/10 : 0
  }));
}

// --- CSV export helper
function exportCSV(rows, headers, filename){
  // …
}


// --- CSV export helper
function exportCSV(rows, headers, filename){
  const head = headers.join(',');
  const lines = rows.map(r => headers
    .map(h => String(r[h] ?? '').replace(/"/g,'""'))
    .map(v => `"${v}"`).join(',')
  );
  const csv = [head].concat(lines).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 0);
}

// --- rendu "plein écran" avancé
function renderDashboardFull(){
  const board = $("visitorBoard");
  const scopeSel = board.querySelector('#kpiScopeFS');
  const currentScope = scopeSel ? scopeSel.value : (BUILDING_FLOORS[buildingSelect.value] ? buildingSelect.value : "building");

  const scopeOptions = [
    ...Object.keys(BUILDING_FLOORS).map(b => `<option value="${b}"${currentScope===b?' selected':''}>Bâtiment ${b}</option>`),
    `<option value="all"${currentScope==='all'?' selected':''}>Village (tous)</option>`
  ].join('');

  board.innerHTML = `
    <div class="board-actions">
      <button class="iconbtn" id="boardMin"   title="Réduire">⤢</button>
      <button class="iconbtn" id="boardClose" title="Fermer">✕</button>
    </div>
    <div class="fs-toolbar">
      <div class="fs-left">
        <strong style="font-size:14px">Dashboard</strong>
        <label>Vue :</label>
        <select id="kpiScopeFS" class="select">${scopeOptions}</select>
      </div>
    <div class="fs-right">
  <label style="font-size:12px">Cible occupation</label>
  <input type="range" id="fsOccTarget" min="50" max="100" step="1" value="85">
  <span class="hint" id="fsOccLabel">85%</span>
  <button class="btn" id="fsExport">Exporter CSV</button>
</div>
    </div>
    <div class="grid-kpis-4" id="kpisFS"></div>

    <div class="grid2" style="margin-top:10px">
      <div class="card">
        <h5>Répartition par statut (nb espaces)</h5>
        <div class="canvas-wrap"><canvas id="fsStatus"></canvas></div>
        <div id="fsLegendStatus" class="legend"></div>
      </div>
      <div class="card">
        <h5>m² occupés vs vacants</h5>
        <div class="canvas-wrap"><canvas id="fsArea"></canvas></div>
        <div id="fsLegendArea" class="legend"></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div class="card">
        <h5>Taux d’occupation par étage</h5>
        <div class="canvas-wrap"><canvas id="fsByFloor"></canvas></div>
        <div class="hint" id="fsByFloorHint" style="margin-top:6px"></div>
      </div>
      <div class="card">
        <h5>Postes occupés vs vacants</h5>
        <div class="canvas-wrap"><canvas id="fsPosts"></canvas></div>
        <div id="fsLegendPosts" class="legend"></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div class="card">
        <h5>Top 10 vacants (m²)</h5>
        <div class="table tight" id="fsVacants"></div>
      </div>
      <div class="card">
        <h5>Préavis à risque</h5>
        <div class="table tight" id="fsPreavis"></div>
      </div>
    </div>
  `;

  $("kpiScopeFS").onchange = ()=> renderDashboardFull();
  $("fsOccTarget").oninput = (e)=>{ $("fsOccLabel").textContent = e.target.value + "%"; renderDashboardFull(); };
  wireBoardActions();

  // --- données & calculs
  const feats = getFeaturesForScope($("kpiScopeFS").value);
  const featsFiltered = feats.filter(fe=>{
    const ep = (fe.options && fe.options.ep) || {};
    const matchesStatus = activeStatuses.has(ep.status || "Vacant");
    const isEvent = (ep.label === "Evenementiel");
    const typeOk = !filterEventOnly || isEvent;
    const text = `${ep.code||""} ${ep.label||""} ${ep.tenant||""}`.toLowerCase();
    const matchText = !searchText || text.includes(searchText);
    return matchesStatus && typeOk && matchText;
  });
  const S = aggStats(featsFiltered);

  // Variables utiles
  const occTarget   = parseInt($("fsOccTarget").value,10) || 85;
  const totalArea   = (S.areaOcc||0) + (S.areaVac||0);
  const needOccM2   = Math.max(0, Math.round(((occTarget/100) * totalArea) - (S.areaOcc||0))); // (3) renommé + calcul clair
  const mrrFacture  = S.rentFacture || 0;                    // (4) nouveau KPI
  const mrrRisk     = (S.rent && S.rent["Préavis"]) || 0;    // (4) nouveau KPI
  const rentPot     = S.rentPotentiel || 0;
  const rentGap     = Math.max(0, Math.round(rentPot - mrrFacture)); // (5) "manque à gagner (potentiel - facturé)"
  const addRev      = Math.round(needOccM2 * ((S.areaOcc||0) ? (mrrFacture / S.areaOcc) : 0)); // estimation simple

  // ✅ (2)(3)(4)(5) — nouvelle rangée de KPI (sans "objectif" doublonné, libellé clarifié, ajout MRR)
  $("kpisFS").innerHTML = `
    <div class="kpi card soft"><div class="v">${S.occupiedCount} <span class="subl">(${S.occupiedPct}%)</span></div><div class="l">Bureaux occupés</div></div>
    <div class="kpi card soft"><div class="v">${S.vacantCount} <span class="subl">(${S.vacantPct}%)</span></div><div class="l">Bureaux vacants</div></div>
    <div class="kpi card soft"><div class="v">${Math.round(S.areaOcc)} m²</div><div class="l">m² occupés</div></div>
    <div class="kpi card soft"><div class="v">${Math.round(S.areaVac)} m²</div><div class="l">m² vacants</div></div>

    <div class="kpi card soft"><div class="v">${euro(mrrFacture)} €</div><div class="l">MRR facturé (€/mois)</div></div>
    <div class="kpi card soft"><div class="v">${euro(mrrRisk)} €</div><div class="l">MRR à risque — préavis</div></div>
    <div class="kpi card soft"><div class="v">${euro(rentGap)} €</div><div class="l">Manque à gagner <span class="subl">(potentiel – facturé)</span></div></div>
    <div class="kpi card soft"><div class="v">${occTarget}%</div><div class="l">Cible d’occupation</div></div>

    <div class="kpi card soft"><div class="v">${needOccM2} m²</div><div class="l">m² à louer pour atteindre l’objectif<br><span class="subl">calculé = objectif% × m² total – m² occupés (≥ 0)</span></div></div>
    <div class="kpi card soft"><div class="v">${euro(addRev)} €</div><div class="l">Revenu supp. estimé</div></div>
    <div class="kpi card soft"><div class="v">${Math.round(S.area["Préavis"]||0)} m²</div><div class="l">Préavis</div></div>
    <div class="kpi card soft"><div class="v">${Math.round(S.area["Maintenance"]||0)} m²</div><div class="l">Maintenance</div></div>
  `;

  // Donut statuts
  const statusLabels = ["Loué","Préavis","Vacant","Réservé","Maintenance"];
  const statusParts  = statusLabels.map(s => S.counts[s] || 0);
  const statusColors = statusLabels.map(s => STATUS_STYLES[s].fill);
  drawDonut($("fsStatus"), statusParts, statusColors, String(S.totalSpaces||0));
  $("fsLegendStatus").innerHTML = statusLabels.map((lab,i)=>{
    const v = statusParts[i]||0; if(!v) return "";
    const pct = Math.round(v*1000/(S.totalSpaces||1))/10;
    return `<div class="item"><span class="dot" style="background:${statusColors[i]}"></span>${lab} — ${v} (${pct}%)</div>`;
  }).join("");

  // Donut m² occ/vac
  const occ = S.areaOcc||0, vac = S.areaVac||0, totA=(occ+vac)||1;
  const occPct = Math.round(occ*1000/totA)/10;
  drawDonut($("fsArea"), [occ,vac], [STATUS_STYLES["Loué"].fill, STATUS_STYLES["Vacant"].fill], `${Math.round(occPct)}%`);
  $("fsLegendArea").innerHTML = `
    <div class="item"><span class="dot" style="background:${STATUS_STYLES["Loué"].fill}"></span>Occupés — ${Math.round(occ)} m² (${occPct}%)</div>
    ${vac?`<div class="item"><span class="dot" style="background:${STATUS_STYLES["Vacant"].fill}"></span>Vacants — ${Math.round(vac)} m² (${Math.round(vac*1000/totA)/10}%)</div>`:""}
  `;

  // ✅ (6) Taux d’occupation par étage — toujours affiché, trié décroissant & cliquable
  const byFloor = floorsStats($("kpiScopeFS").value).sort((a,b)=> (b.rate||0) - (a.rate||0));
  if (byFloor.length){
    const labels = byFloor.map(x => `${x.b} ${x.f}`);
    const values = byFloor.map(x => Math.round(x.rate));
    drawBars($("fsByFloor"), labels, values, [STATUS_STYLES["Loué"].fill], (idx)=>{
      const item = byFloor[idx]; if(!item) return;
      // switch plan vers le bâtiment/étage cliqué
      if (BUILDING_FLOORS[item.b] && (BUILDING_FLOORS[item.b]||[]).includes(item.f)){
        buildingSelect.value = item.b; buildFloorOptions(item.b); floorSelect.value = item.f;
        onKeyChange();
      }
    });
    $("fsByFloorHint").textContent = "Clique une barre pour ouvrir le plan correspondant.";
  } else {
    // message même s’il n’y a pas encore de données
    const c = $("fsByFloor").getContext("2d");
    c.clearRect(0,0,$("fsByFloor").width,$("fsByFloor").height);
    $("fsByFloorHint").textContent = "Aucune donnée d’étage disponible pour cette vue.";
  }

  // Postes
  const pOcc = S.occPosts||0, pVac=S.vacPosts||0, pTot=(pOcc+pVac)||1;
  if (pOcc+pVac>0){
    const pOccPct = Math.round(pOcc*1000/pTot)/10;
    drawDonut($("fsPosts"), [pOcc,pVac], [STATUS_STYLES["Loué"].fill, STATUS_STYLES["Vacant"].fill], `${Math.round(pOccPct)}%`);
    $("fsLegendPosts").innerHTML = `
      <div class="item"><span class="dot" style="background:${STATUS_STYLES["Loué"].fill}"></span>Occupés — ${pOcc} (${pOccPct}%)</div>
      ${pVac?`<div class="item"><span class="dot" style="background:${STATUS_STYLES["Vacant"].fill}"></span>Vacants — ${pVac} (${Math.round(pVac*1000/pTot)/10}%)</div>`:""}
    `;
  } else {
    const cv = $("fsPosts"); const ctx = cv.getContext("2d");
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.font = "14px Inter,system-ui"; ctx.fillStyle="#6e6e73"; ctx.textAlign="center";
    ctx.fillText("Aucune donnée de postes", cv.width/2, 24);
    $("fsLegendPosts").innerHTML = ``;
  }

  // Top 10 vacants
  const vacants = featsFiltered
    .map(fe => (fe.options && fe.options.ep) || {})
    .filter(ep => ep.status==="Vacant")
    .sort((a,b)=> (b.area||0)-(a.area||0))
    .slice(0,10);
  $("fsVacants").innerHTML = vacants.length
    ? `<div class="table"><table><thead><tr><th>Code</th><th>Libellé</th><th>m²</th><th>Posts</th></tr></thead><tbody>${
        vacants.map(v=> `<tr><td>${v.code||"—"}</td><td>${v.label||"—"}</td><td>${Math.round(v.area||0)}</td><td>${v.posts||0}</td></tr>`).join("")
      }</tbody></table></div>`
    : `<div class="hint">Aucun vacant</div>`;

  // Préavis à risque
  const preavis = featsFiltered
    .map(fe => (fe.options && fe.options.ep) || {})
    .filter(ep => ep.status==="Préavis")
    .sort((a,b)=> (b.area||0)-(a.area||0));
  $("fsPreavis").innerHTML = preavis.length
    ? `<div class="table"><table><thead><tr><th>Code</th><th>Résident</th><th>m²</th><th>€ / mois</th></tr></thead><tbody>${
        preavis.map(v=> `<tr><td>${v.code||"—"}</td><td>${v.tenant||"—"}</td><td>${Math.round(v.area||0)}</td><td>${euro(v.rent||0)}</td></tr>`).join("")
      }</tbody></table></div>`
    : `<div class="hint">Aucun préavis</div>`;

  // Export CSV
  $("fsExport").onclick = ()=>{
    const rows = []
      .concat(vacants.map(v=> ({type:"Vacant", code:v.code||"", label:v.label||"", tenant:v.tenant||"", area:v.area||0, posts:v.posts||0, rent:v.rent||0})))
      .concat(preavis.map(v=> ({type:"Préavis", code:v.code||"", label:v.label||"", tenant:v.tenant||"", area:v.area||0, posts:v.posts||0, rent:v.rent||0})));
    exportCSV(rows, ["type","code","label","tenant","area","posts","rent"], "dashboard_export.csv");
  };
}

// Charts
function drawDonut(canvas, parts, colors, centerText){
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.clientWidth * devicePixelRatio;
  const H = canvas.height = 200 * devicePixelRatio;
  const cx=W/2, cy=H/2, r=Math.min(W,H)*0.36, r2=r*0.66;
  const total = parts.reduce((a,b)=>a+b,0) || 1;
  let a0 = -Math.PI/2;
  ctx.clearRect(0,0,W,H);
  parts.forEach((v,i)=>{
    const ang = v/total * Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a0+ang); ctx.closePath(); ctx.fillStyle = colors[i%colors.length]; ctx.fill();
    a0 += ang;
  });
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle = "#1c1c1e"; ctx.font = `${Math.round(r*0.28)}px SF Pro, Inter, system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(centerText, cx, cy);
}
function drawBars(canvas, labels, values, colors = ["#0a84ff"], onBarClick){
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.clientWidth * devicePixelRatio;
  const H = canvas.height = 200 * devicePixelRatio;
  ctx.clearRect(0,0,W,H);

  const max = Math.max(...values, 1);
  const mL = 10*devicePixelRatio, mR = 10*devicePixelRatio, mT = 10*devicePixelRatio, mB = 24*devicePixelRatio;
  const plotW = W - mL - mR, plotH = H - mT - mB;
  const n = values.length; const gap = plotW*0.08/(n||1); const bw = (plotW - gap*(n+1)) / (n||1);
  const baseY = mT + plotH;

  ctx.fillStyle = "#e5e5ea"; ctx.fillRect(mL, baseY, plotW, 1*devicePixelRatio);

  const hitboxes = [];
  values.forEach((v,i)=>{
    const x = mL + gap + i*(bw+gap);
    const h = v/max * (plotH-6*devicePixelRatio);
    const y = baseY - h;

    ctx.fillStyle = colors[i % colors.length];
    const radius = 8*devicePixelRatio; const w=bw, r=Math.min(radius, w/2, h);
    ctx.beginPath();
    ctx.moveTo(x, y+r); ctx.arcTo(x, y, x+r, y, r); ctx.lineTo(x+w-r, y); ctx.arcTo(x+w, y, x+w, y+r, r);
    ctx.lineTo(x+w, y+h); ctx.lineTo(x, y+h); ctx.closePath(); ctx.fill();

    ctx.fillStyle = "#1c1c1e"; ctx.font = `${12*devicePixelRatio}px Inter, system-ui`; ctx.textAlign='center';
    let ty = y - 6*devicePixelRatio; if (ty < mT + 10*devicePixelRatio) ty = y + 14*devicePixelRatio;
    ctx.fillText(String(v), x+w/2, ty);

    ctx.fillStyle = "#3a3a3c"; ctx.font = `${11*devicePixelRatio}px Inter, system-ui`;
    ctx.fillText(labels[i].slice(0,18), x+w/2, baseY + 14*devicePixelRatio);

    hitboxes.push({x, y, w, h, index:i});
  });

  // Clicks
  canvas.__barHitboxes = hitboxes;
  canvas.onclick = onBarClick
    ? (e)=>{
        const r = canvas.getBoundingClientRect();
        const px = (e.clientX - r.left) * devicePixelRatio;
        const py = (e.clientY - r.top)  * devicePixelRatio;
        const hit = (canvas.__barHitboxes||[]).find(b => px>=b.x && px<=b.x+b.w && py>=b.y && py<=b.y+b.h);
        if(hit) onBarClick(hit.index, labels[hit.index]);
      }
    : null;
}

// ===== Dashboard (renders + CLICKABLE legend)
function renderDashboard(){
  const board = $("visitorBoard");
  // Si le board est en plein écran, on délègue à la version "full"
  if (board && board.classList.contains("fullscreen")) {
    return renderDashboardFull();
  }

  // Portée sélectionnée (bâtiment courant par défaut)
  const existing = board.querySelector('#kpiScope');
  const currentScope = existing ? existing.value : buildingSelect.value;
  const scopeOptions = [
    ...Object.keys(BUILDING_FLOORS).map(b =>
      `<option value="${b}"${currentScope===b?' selected':''}>Bâtiment ${b}</option>`
    ),
    `<option value="all"${currentScope==='all'?' selected':''}>Statistiques du village</option>`
  ].join('');

  // Gabarit "panneau"
  board.innerHTML = `
    <h4>Dashboard</h4>
    <div class="sub">
      <div class="scope">
        <span>Vue :</span>
        <select id="kpiScope">${scopeOptions}</select>
      </div>
    </div>
    <div class="board-actions inpanel">
      <button class="iconbtn" id="boardBack" title="Revenir à l’édition">←</button>
      <button class="iconbtn" id="boardPop"  title="Ouvrir le dashboard complet">↗</button>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="grid2">
      <div class="card">
        <h5>Répartition par statut (nb espaces)</h5>
        <div class="canvas-wrap"><canvas id="chartStatusCount"></canvas></div>
        <div id="legendStatus" class="legend"></div>
      </div>
      <div class="card">
        <h5>m² occupés vs vacants</h5>
        <div class="canvas-wrap"><canvas id="chartAreaOccVac"></canvas></div>
        <div id="legendArea" class="legend"></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div class="card">
        <h5>Postes occupés vs vacants</h5>
        <div class="canvas-wrap"><canvas id="chartPostsOccVac"></canvas></div>
        <div id="legendPosts" class="legend"></div>
      </div>
      <div class="card">
        <h5>Top 5 loyers par résident</h5>
        <div class="canvas-wrap"><canvas id="chartTopRent"></canvas></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div class="card">
        <h5>Top 5 résidents
          <select id="topMode" style="margin-left:8px;padding:4px 8px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--panel);">
            <option value="count">par nombre d'espaces</option>
            <option value="area">par m² occupés</option>
          </select>
        </h5>
        <div class="canvas-wrap"><canvas id="chartTopTenants"></canvas></div>
      </div>
      <div class="card">
        <h5>Réservés (à venir)</h5>
        <div id="reservedList"></div>
      </div>
    </div>
  `;

  $("kpiScope").onchange = () => renderDashboard();
  wireBoardActions();

  // Données selon la portée + filtres identiques à la carte
  const feats = getFeaturesForScope($("kpiScope").value);
  const featsFiltered = feats.filter(fe => {
    const ep = (fe.options && fe.options.ep) || {};
    const matchesStatus = activeStatuses.has(ep.status || "Vacant");
    const isEvent = (ep.label === "Evenementiel");
    const typeOk = !filterEventOnly || isEvent;
    const text = `${ep.code||""} ${ep.label||""} ${ep.tenant||""}`.toLowerCase();
    const matchText = !searchText || text.includes(searchText);
    return matchesStatus && typeOk && matchText;
  });
  const S = aggStats(featsFiltered);

  // KPIs
  $("kpis").innerHTML = `
    <div class="kpi"><div class="v">${S.occupiedCount} <span class="subl">(${S.occupiedPct}%)</span></div><div class="l">Bureaux occupés</div></div>
    <div class="kpi"><div class="v">${S.vacantCount} <span class="subl">(${S.vacantPct}%)</span></div><div class="l">Bureaux vacants</div></div>
    <div class="kpi"><div class="v">${Math.round(S.areaOcc)} m²</div><div class="l">m² occupés</div></div>
    <div class="kpi"><div class="v">${Math.round(S.areaVac)} m²</div><div class="l">m² vacants</div></div>
    <div class="kpi"><div class="v">${euro(S.rentFacture)} €</div><div class="l">Loyer facturé (occupés)</div></div>
    <div class="kpi"><div class="v">${euro(S.rentPotentiel)} €</div><div class="l">Loyer potentiel (après réservés)</div></div>
    <div class="kpi"><div class="v">${Math.round(S.euroPerPost)} €</div><div class="l">€ / poste (moyenne)</div></div>
  `;

  // Répartition par statut (donut + légende cliquable)
  const statusLabels = ["Loué","Préavis","Vacant","Réservé","Maintenance"];
  const statusParts  = statusLabels.map(s => S.counts[s] || 0);
  const statusColors = statusLabels.map(s => (s === "Réservé" && filterEventOnly) ? EVENT_DEFAULT_COLOR : STATUS_STYLES[s].fill);
  drawDonut($("chartStatusCount"), statusParts, statusColors, String(S.totalSpaces || 0));
  const total = S.totalSpaces || 1;
  $("legendStatus").innerHTML = statusLabels.map((lab,i)=>{
    const v = statusParts[i] || 0; if(!v) return "";
    const pct = Math.round(v*1000/total)/10;
    return `<div class="item" role="button" style="cursor:pointer" data-status="${lab}">
              <span class="dot" style="background:${statusColors[i]}"></span>${lab} — ${v} (${pct}%)
            </div>`;
  }).join("");
  $("legendStatus").querySelectorAll(".item").forEach(n => n.onclick = () => showStatusList(n.dataset.status));

  // m² occupés vs vacants
  const occ = S.areaOcc || 0, vac = S.areaVac || 0, totA = (occ + vac) || 1;
  const occPct = Math.round(occ*1000/totA)/10, vacPct = Math.round(vac*1000/totA)/10;
  drawDonut($("chartAreaOccVac"), [occ, vac], [STATUS_STYLES["Loué"].fill, STATUS_STYLES["Vacant"].fill], `${Math.round(occPct)}%`);
  $("legendArea").innerHTML = `
    <div class="item" role="button" style="cursor:pointer" data-area="occupied">
      <span class="dot" style="background:${STATUS_STYLES["Loué"].fill}"></span>
      Occupés — ${Math.round(occ)} m² (${occPct}%)
    </div>
    ${vac>0 ? `<div class="item" role="button" style="cursor:pointer" data-area="vacant">
      <span class="dot" style="background:${STATUS_STYLES["Vacant"].fill}"></span>
      Vacants — ${Math.round(vac)} m² (${vacPct}%)
    </div>` : ""}`;
  $("legendArea").querySelectorAll(".item").forEach(n => n.onclick = () => showAreaList(n.dataset.area));

  // Top 5 résidents (mode)
  const topSel = $("topMode");
  const savedMode = window.TOP_TENANTS_MODE || "count";
  if (topSel){ topSel.value = savedMode; topSel.onchange = (e)=>{ window.TOP_TENANTS_MODE = e.target.value; renderDashboard(); }; }
  const mode = window.TOP_TENANTS_MODE || (topSel ? topSel.value : "count");
  const topData = (mode==="area" ? (S.tenantsAreaArr||[]) : (S.tenantsArr||[]));
  const labels = topData.map(t=> t.tenant);
  const values = topData.map(t=> mode==="area" ? Math.round(t.area||0) : t.count);
  const barColorContext = filterEventOnly ? EVENT_DEFAULT_COLOR : STATUS_STYLES["Loué"].fill;
  drawBars($("chartTopTenants"), labels, values, [barColorContext]);

  // Postes
  const pOcc = S.occPosts || 0, pVac = S.vacPosts || 0, pTot = (pOcc + pVac) || 1;
  const pOccPct = Math.round(pOcc*1000/pTot)/10, pVacPct = Math.round(pVac*1000/pTot)/10;
  if ((pOcc + pVac) > 0){
    drawDonut($("chartPostsOccVac"), [pOcc, pVac], [STATUS_STYLES["Loué"].fill, STATUS_STYLES["Vacant"].fill], `${Math.round(pOccPct)}%`);
    $("legendPosts").innerHTML = `
      <div class="item" role="button" style="cursor:pointer" data-posts="occupied">
        <span class="dot" style="background:${STATUS_STYLES["Loué"].fill}"></span>
        Occupés — ${pOcc} (${pOccPct}%)
      </div>
      ${pVac>0 ? `<div class="item" role="button" style="cursor:pointer" data-posts="vacant">
        <span class="dot" style="background:${STATUS_STYLES["Vacant"].fill}"></span>
        Vacants — ${pVac} (${pVacPct}%)
      </div>` : ""}`;
    $("legendPosts").querySelectorAll(".item").forEach(n => n.onclick = () => showPostsList(n.dataset.posts));
  } else {
    const cv = $("chartPostsOccVac"); const ctx = cv.getContext("2d");
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.font = "14px Inter,system-ui"; ctx.fillStyle="#6e6e73"; ctx.textAlign="center";
    ctx.fillText("Aucune donnée de postes", cv.width/2, 24);
    $("legendPosts").innerHTML = ``;
  }

  // Top loyers
  const topRent = (S.tenantsRentArr||[]);
  if (topRent.length){
    drawBars($("chartTopRent"), topRent.map(t => t.tenant), topRent.map(t => Math.round(t.rent || 0)), [barColorContext]);
  } else {
    const c = $("chartTopRent"); const ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);
    ctx.font="14px Inter,system-ui"; ctx.fillStyle="#6e6e73"; ctx.textAlign="center";
    ctx.fillText("Aucun loyer renseigné", c.width/2, 24);
  }

  // Réservés
  const r = $("reservedList");
  if(!S.reservedList || S.reservedList.length===0){
    r.innerHTML = '<div class="hint">Aucun espace réservé.</div>';
  }else{
    r.innerHTML = S.reservedList
      .sort((a,b)=> b.area-a.area)
      .map(v=> `<div class="rowlist"><div>${v.code} — ${v.label}</div><div class="badge">${v.area||0} m²</div><div class="badge">Réservé</div></div>`)
      .join('');
  }
}

// === Modal helpers (GLOBAUX — en dehors de renderDashboard)

// --- Dézoome un peu plus quand on focus un espace
function focusSpaceByCode(code){
  let target = null;
  drawn.eachLayer(l => { if (layerProps(l).code === code) target = l; });
  if (target){
    // padding plus large + évite de zoomer trop près
    map.fitBounds(target.getBounds(), { padding:[120,120], maxZoom:-1 });
    target.openTooltip && target.openTooltip();
    closeStatusModal();
  } else {
    const s = $("statusText"); const old = s.textContent;
    s.textContent = `« ${code} » n'est pas sur cet étage`;
    setTimeout(()=> s.textContent = old, 1200);
  }
}
  function openStatusModal(status, items){
  document.getElementById("statusModalTitle").textContent =
    `${status} — ${items.length} espace(s)`;

  const html = items.map(({ep, key})=>{
    const code   = ep.code || "—";
    const label  = ep.label || "—";
    const tenant = (ep.tenant || "").trim();
    const area   = ep.area ? `${ep.area} m²` : "";

    const onThisFloor = (key === currentKey) && (()=>{
      let ok=false; drawn.eachLayer(l=>{ if(layerProps(l).code===ep.code) ok=true; });
      return ok;
    })();

    const btnHtml = onThisFloor
      ? `<button class="btn pill primary" data-goto="${code}">Voir</button>`
      : `<button class="btn pill primary" data-goto="${code}" data-goto-key="${key}">Ouvrir et voir</button>`;

    const place = (key!==currentKey)
      ? `<span class="badge soft">${key.replace('|',' — ')}</span>`
      : '';

    return `
      <div class="rowlist space-item">
        <div class="left">
          <div class="title">${code} — ${label}</div>
          <div class="meta">
            ${area ? `<span class="badge soft">${area}</span>` : ""}
            ${tenant ? `<span class="badge">${tenant}</span>` : ""}
            ${place}
          </div>
        </div>
        <div class="right">${btnHtml}</div>
      </div>
    `;
  }).join("");

  document.getElementById("statusModalContent").innerHTML =
    html || "<div class='hint'>Aucun espace</div>";

  document.getElementById("statusModal").classList.add("open");

  // Wiring des boutons après insertion du HTML
  document
    .getElementById("statusModalContent")
    .querySelectorAll("[data-goto]")
    .forEach(btn=>{
      btn.onclick = async () => {
        btn.classList.add("success","flash");
        setTimeout(()=> btn.classList.remove("success","flash"), 700);

        const code = btn.dataset.goto;
        const key  = btn.dataset.gotoKey;
        if (key){
          await (async function switchToKeyAndFocus(key, code){
            const [b,f] = key.split("|");
            if (!BUILDING_FLOORS[b] || !(BUILDING_FLOORS[b]||[]).includes(f)) return;
            buildingSelect.value = b;
            buildFloorOptions(b);
            floorSelect.value = f;
            await onKeyChange();
            focusSpaceByCode(code);
          })(key, code);
        } else {
          focusSpaceByCode(code);
        }
      };
    });
}

function closeStatusModal(){ $("statusModal").classList.remove("open"); }
  // --- Liste des postes (occupés / vacants)
// --- m² (occupés / vacants) — portée globale
function showAreaList(kind){
  const sel = $("kpiScope");
  const picked = sel ? sel.value : "building";          // "all" ou "A".."R"
  const curB = buildingSelect.value;
  const curF = floorSelect.value;
  const curKey = keyFor(curB, curF);

  const isAll = picked === "all";
  const targetB = BUILDING_FLOORS[picked] ? picked : curB;

  const items = [];
  const isOccupied  = (kind === "occupied");
  const isOccStatus = s => (s==="Loué" || s==="Préavis");

  function pushFromStore(key){
    const store = (key === curKey) ? exportGeo() : loadFromCache(key);
    const feats = (store && store.features) || [];
    feats.forEach(fe=>{
      const ep       = (fe.options && fe.options.ep) || {};
      const areaVal  = Number(ep.area||0);
      const status   = ep.status || "Vacant";
      const isEvent  = (ep.label === "Evenementiel");
      const typeOk   = !filterEventOnly || isEvent;

      const matchesStatus = activeStatuses.has(status);
      const text = `${ep.code||""} ${ep.label||""} ${ep.tenant||""}`.toLowerCase();
      const matchText = !searchText || text.includes(searchText);

      const belongs = isOccupied ? isOccStatus(status) : (status === "Vacant");

      if (areaVal > 0 && matchesStatus && matchText && typeOk && belongs){
        items.push({ ep, key });
      }
    });
  }

  if (isAll){
    Object.keys(BUILDING_FLOORS).forEach(b =>
      (BUILDING_FLOORS[b]||[]).forEach(f => pushFromStore(keyFor(b,f)))
    );
  } else {
    (BUILDING_FLOORS[targetB]||[]).forEach(f => pushFromStore(keyFor(targetB,f)));
  }

  items.sort((a,b)=>{
    const d = (Number(b.ep.area||0) - Number(a.ep.area||0));
    if (d) return d;
    return (a.ep.code||"").localeCompare(b.ep.code||"");
  });

  openStatusModal(isOccupied ? "m² occupés" : "m² vacants", items);
}


// --- Postes (occupés / vacants) — portée globale
function showPostsList(kind){
  const sel = $("kpiScope");
  const picked = sel ? sel.value : "building";
  const curB = buildingSelect.value;
  const curF = floorSelect.value;
  const curKey = keyFor(curB, curF);

  const isAll = picked === "all";
  const targetB = BUILDING_FLOORS[picked] ? picked : curB;

  const items = [];
  const isOccupied = (kind === "occupied");
  const isOccStatus = s => (s==="Loué" || s==="Préavis");

  function pushFromStore(key){
    const store = (key === curKey) ? exportGeo() : loadFromCache(key);
    const feats = (store && store.features) || [];
    feats.forEach(fe=>{
      const ep = (fe.options && fe.options.ep) || {};
      const postsVal = parseInt(ep.posts||0,10)||0;
      const status   = ep.status || "Vacant";
      const isEvent  = (ep.label === "Evenementiel");

      const matchesStatus = activeStatuses.has(status);
      const text = `${ep.code||""} ${ep.label||""} ${ep.tenant||""}`.toLowerCase();
      const matchText = !searchText || text.includes(searchText);

      const belongs = isOccupied ? isOccStatus(status) : !isOccStatus(status);

      if (postsVal > 0 && !isEvent && matchesStatus && matchText && belongs){
        items.push({ ep, key });
      }
    });
  }

  if (isAll){
    Object.keys(BUILDING_FLOORS).forEach(b =>
      (BUILDING_FLOORS[b]||[]).forEach(f => pushFromStore(keyFor(b,f)))
    );
  } else {
    (BUILDING_FLOORS[targetB]||[]).forEach(f => pushFromStore(keyFor(targetB,f)));
  }

  items.sort((a,b)=>{
    const d = (parseInt(b.ep.posts||0,10) || 0) - (parseInt(a.ep.posts||0,10) || 0);
    if (d) return d;
    return (a.ep.code||"").localeCompare(b.ep.code||"");
  });

  openStatusModal(isOccupied ? "Postes occupés" : "Postes vacants", items);
}


// --- Liste par statut : récupère *avec la clé b|f* pour permettre la bascule auto
function showStatusList(status){
  const sel = $("kpiScope");
  const picked = sel ? sel.value : "building";
  const curB = buildingSelect.value;
  const curF = floorSelect.value;
  const curKey = keyFor(curB, curF);

  const isAll = picked === "all";
  const targetB = BUILDING_FLOORS[picked] ? picked : curB;

  const items = [];

  function pushFromStore(key){
    const store = (key === curKey) ? exportGeo() : loadFromCache(key);
    const feats = (store && store.features) || [];
    feats.forEach(fe=>{
      const ep = (fe.options && fe.options.ep) || {};
      if (ep.status === status){
        items.push({ ep, key });
      }
    });
  }

  if (isAll){
    Object.keys(BUILDING_FLOORS).forEach(b =>
      (BUILDING_FLOORS[b]||[]).forEach(f => pushFromStore(keyFor(b,f)))
    );
  } else {
    (BUILDING_FLOORS[targetB]||[]).forEach(f => pushFromStore(keyFor(targetB,f)));
  }

  items.sort((a,b)=>{
    const aa = (a.ep.code||"").localeCompare(b.ep.code||"");
    if (aa!==0) return aa;
    return (b.ep.area||0) - (a.ep.area||0);
  });

  openStatusModal(status, items);
}

function updateBoard(){
  const b = $("visitorBoard");
  if (!b) return;
  const visible =
    document.body.classList.contains("board-mode") ||  // dashboard dans le panneau
    b.classList.contains("fullscreen") ||              // mode plein écran
    b.style.display === "block";                       // visible en overlay

  if (visible) renderDashboard();
}

// Autocomplete
const tnInput = $("fTenant");
const suggest = $("tenantSuggest");
(function(){
  const wrap = tnInput.closest('.tenant-field') || tnInput.parentElement;
  if(wrap && suggest.parentElement !== wrap){
    wrap.style.position = 'relative';
    wrap.appendChild(suggest);
  }
})();
function norm(s){
  return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/\s+/g," ").trim();
}
function collectTenantStats(){
  const mapCounts = new Map();
  function addName(name){
    const t = (name||"").trim();
    if(!t || norm(t)==="vacant") return;
    const n = norm(t);
    const cur = mapCounts.get(n) || {name:t, count:0};
    cur.count += 1;
    if(t.length > cur.name.length) cur.name = t;
    mapCounts.set(n, cur);
  }
  exportGeo().features.forEach(fe=> addName((fe.options&&fe.options.ep&&fe.options.ep.tenant)||""));
  Object.keys(BUILDING_FLOORS).forEach(b=> (BUILDING_FLOORS[b]||[]).forEach(f=>{
    const st = loadFromCache(keyFor(b,f));
    (st?.features||[]).forEach(fe=> addName((fe.options&&fe.options.ep&&fe.options.ep.tenant)||""));
  }));
  return mapCounts;
}
function suggestionsFor(q, limit=6){
  const qn = norm(q);
  if (qn.length < 2) return [];
  const stats = collectTenantStats();
  const arr = [...stats.values()]
    .filter(it => norm(it.name).includes(qn))
    .sort((a,b) => (b.count - a.count) || a.name.localeCompare(b.name))
    .slice(0, limit);
  return arr;
}

function positionSuggest(el){
  suggest.style.left = '0px'; suggest.style.right = '0px'; suggest.style.width = '100%';
  suggest.style.top  = (el.offsetTop + el.offsetHeight + 6 - (tnInput.offsetTop)) + 'px';
}
function showSuggest(items){
  if(items.length===0){ suggest.style.display="none"; return; }
  suggest.innerHTML = items.map(it=> `<div class="item" role="option"><span class="icon">🏷️</span>${it.name}</div>`).join("");
  positionSuggest(tnInput);
  suggest.style.display="block";
  [...suggest.querySelectorAll(".item")].forEach((node)=>{
    node.onmousedown = (e)=>{
      e.preventDefault();
      tnInput.value = node.textContent.replace("🏷️","").trim();
      suggest.style.display="none";
    };
  });
}
tnInput.addEventListener("input", ()=>{ showSuggest(suggestionsFor(tnInput.value)); });
tnInput.addEventListener("focus", ()=>{ showSuggest(suggestionsFor(tnInput.value)); });
document.addEventListener("click", (e)=>{
  if(e.target!==tnInput && !suggest.contains(e.target)){ suggest.style.display="none"; }
});
</script>
  

<!-- 🚨 MODALE LISTE STATUT — en dehors de <script> et avant </body> -->
<div class="modal" id="statusModal" aria-hidden="true">
  <div class="pad" role="dialog" aria-modal="true" style="max-width:600px;width:90%">
    <h4 id="statusModalTitle">Espaces</h4>
    <div id="statusModalContent" style="max-height:60vh;overflow:auto;margin-top:12px"></div>
    <div style="text-align:right;margin-top:12px">
      <button class="btn" onclick="closeStatusModal()">Fermer</button>
    </div>
  </div>
</div>
  <script>
 function __openDashboardFull(){
  const b = document.getElementById("visitorBoard");
  if(!b) return;
  document.body.classList.add('dashboard-fullscreen');   // <—
  b.classList.add("fullscreen");
  b.style.display = "block";
  renderDashboard();
}
  document.addEventListener("DOMContentLoaded", ()=>{
    if(location.hash==="#dashboard-full") __openDashboardFull();
  });
  window.addEventListener("hashchange", ()=>{
    if(location.hash==="#dashboard-full") __openDashboardFull();
  });
</script>
  <script>
  function syncTopbarHeight(){
    const h = document.querySelector('.topbar')?.offsetHeight || 56;
    document.documentElement.style.setProperty('--topbar-h', h + 'px');
  }
  window.addEventListener('resize', syncTopbarHeight);
  document.addEventListener('DOMContentLoaded', syncTopbarHeight);

/* --- min=today + hint "Expire le …" --- */
document.addEventListener('DOMContentLoaded', function(){
  try{
    var d = document.getElementById('fExitDate');
    if(d) d.min = '2025-09-02';
    var hint = document.getElementById('exitDateHint');
    function fmt(iso){ try{ var p=iso.split('-'); return p[2]+'/'+p[1]+'/'+p[0]; }catch(_){ return iso||'—'; }}
    function sync(){ if(hint) hint.textContent = 'Expire le ' + (d && d.value ? fmt(d.value) : '—'); }
    if(d){ d.addEventListener('change', sync); requestAnimationFrame(sync); }
  }catch(_ ){}
});

</script>


<script>

/* === Custom Apple-like Date Picker logic (desktop only) === */
(function(){
  const isMobile = matchMedia('(hover:none), (pointer:coarse)').matches;
  const input = document.getElementById('fExitDate');
  if(!input) return;

  if(!isMobile){
    input.setAttribute('readonly','readonly');
    input.classList.add('has-button');
    const wrap = input.parentElement || input;
    const btn = document.createElement('button');
    btn.type='button'; btn.className='date-open';
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="16" rx="4"></rect><line x1="8" y1="3" x2="8" y2="7"></line><line x1="16" y1="3" x2="16" y2="7"></line><line x1="3" y1="11" x2="21" y2="11"></line></svg>';
    wrap.style.position='relative';
    wrap.appendChild(btn);

    let pop = null;
    let cur = null;
    const minISO = "2025-09-02";
    const minDate = new Date(minISO+'T00:00:00');

    function parseISO(iso){
      try{ if(!iso) return null; const p=iso.split('-'); return new Date(+p[0], p[1]-1, +p[2]); }catch(e){ return null; }
    }
    function toISO(d){
      const y=d.getFullYear();
      const m=('0'+(d.getMonth()+1)).slice(-2);
      const day=('0'+d.getDate()).slice(-2);
      return y+'-'+m+'-'+day;
    }
    function sameDay(a,b){ return a && b && a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }

    function openPicker(){
      if(pop) return;
      pop = document.createElement('div');
      pop.className='datepicker-popover';

      const sel = parseISO(input.value);
      const today = new Date(); today.setHours(0,0,0,0);
      cur = sel ? new Date(sel.getFullYear(), sel.getMonth(), 1) : new Date(today.getFullYear(), today.getMonth(), 1);

      render();
      document.body.appendChild(pop);
      position();

      setTimeout(()=>{
        function onDoc(e){
          if(!pop) return;
          if(e.target===input || e.target===btn || pop.contains(e.target)) return;
          closePicker();
          document.removeEventListener('mousedown', onDoc);
          document.removeEventListener('focusin', onDoc);
          window.removeEventListener('resize', position);
          window.removeEventListener('scroll', position, true);
        }
        document.addEventListener('mousedown', onDoc);
        document.addEventListener('focusin', onDoc);
        window.addEventListener('resize', position);
        window.addEventListener('scroll', position, true);
      },0);
    }
    function closePicker(){ if(pop){ pop.remove(); pop=null; } }
    function position(){
      if(!pop) return;
      const r = input.getBoundingClientRect();
      const above = (window.scrollY + r.top - pop.offsetHeight - 8);
      const below = (window.scrollY + r.bottom + 8);
      const useAbove = above >= window.scrollY + 8; // if there is room above
      pop.style.top = (useAbove ? above : below) + 'px';
      pop.style.left = (window.scrollX + r.left)+'px';
    }
    function render(){
      if(!pop) return;
      const sel = parseISO(input.value);
      const today = new Date(); today.setHours(0,0,0,0);
      const month = cur.getMonth();
      const year = cur.getFullYear();
      const header = `
        <div class="dp-header">
          <div class="dp-title">${['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'][month]} ${year}</div>
          <div class="dp-nav">
            <div class="dp-btn" data-nav="-1" title="Mois précédent">‹</div>
            <div class="dp-btn" data-nav="1" title="Mois suivant">›</div>
          </div>
        </div>`;
      const wd = ['L','M','M','J','V','S','D'].map(w=>`<div class="dp-weekday">${w}</div>`).join('');
      const first = new Date(year, month, 1);
      const startDay = (first.getDay()+6)%7; // Monday=0
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const cells = [];
      for(let i=0;i<startDay;i++){ cells.push('<div></div>'); }
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(year, month, d); date.setHours(0,0,0,0);
        const iso = toISO(date);
        const disabled = (date < minDate);
        const classes = ['dp-day'];
        if (sameDay(date, today)) classes.push('today');
        if (sel && sameDay(date, sel)) classes.push('selected');
        if (disabled) classes.push('disabled');
        cells.push(`<div class="${classes.join(' ')}" data-iso="${iso}">${d}</div>`);
      }
      const grid = `<div class="dp-grid">${wd}${cells.join('')}</div>`;
      const footer = `<div class="dp-footer"><span class="dp-link" data-act="clear">Effacer</span><span class="dp-link" data-act="today">Aujourd'hui</span></div>`;
      pop.innerHTML = header + grid + footer;

      pop.querySelectorAll('.dp-btn').forEach(el=>{
        el.addEventListener('click',()=>{
          const step = parseInt(el.getAttribute('data-nav'),10)||0;
          cur = new Date(year, month+step, 1);
          render(); position();
        });
      });
      pop.querySelectorAll('.dp-day').forEach(el=>{
        el.addEventListener('click',()=>{
          if(el.classList.contains('disabled')) return;
          const iso = el.getAttribute('data-iso');
          input.value = iso;
          input.dispatchEvent(new Event('change',{bubbles:true}));
          closePicker();
        });
      });
      const clear = pop.querySelector('[data-act="clear"]');
      const todayBtn = pop.querySelector('[data-act="today"]');
      if(clear){ clear.addEventListener('click', ()=>{ input.value=''; input.dispatchEvent(new Event('change',{bubbles:true})); closePicker(); });}
      if(todayBtn){
        todayBtn.addEventListener('click', ()=>{
          const tISO = toISO(today);
          if(today >= minDate){ input.value=tISO; input.dispatchEvent(new Event('change',{bubbles:true})); closePicker(); }
        });
      }
    }

    input.addEventListener('focus', openPicker);
    btn.addEventListener('click', openPicker);
  }
})();

</script>

<style>
#reservedRow .hint{ font-size:11.5px; color:var(--muted); }
</style>
<script>
(function(){ 
  function $(id){ return document.getElementById(id); }
  function ensureReservedRow(){
    if(document.getElementById('reservedRow')) return;
    var row = document.createElement('div'); row.id='reservedRow'; row.className='row3'; row.style.display='none';
    row.innerHTML = `
      <div class="field">
        <label>Date d'entrée</label>
        <input id="fEntryDate" class="input date" type="date">
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <div class="hint"><span id="entryDateHint">Entrée le —</span></div>
      </div>
      <div class="field"><label>&nbsp;</label><div class="hint"></div></div>
    `;
    var preavis = document.getElementById('preavisRow');
    if(preavis && preavis.parentElement) preavis.parentElement.insertBefore(row, preavis);
    else {
      var admin = document.getElementById('adminSection');
      if(admin) admin.appendChild(row);
    }
  }

  function fmt(iso){ try{ if(!iso) return '—'; var p=iso.split('-'); return p[2]+'/'+p[1]+'/'+p[0]; }catch(_ ){ return iso||'—'; } }
  function isEvent(){ var l=$('fLabel'); return l && l.value==='Evenementiel'; }
  function isReserved(){ var s=$('fStatus'); return s && s.value==='Réservé'; }

  function syncReserved(){
    var row=$('reservedRow'); if(!row) return;
    row.style.display = (!isEvent() && isReserved()) ? 'grid' : 'none';
  }
  function updateHint(){
    var d=$('fEntryDate'), h=$('entryDateHint');
    if(h) h.textContent = 'Entrée le ' + (d && d.value ? fmt(d.value) : '—');
  }

  document.addEventListener('DOMContentLoaded', function(){
    ensureReservedRow();
    var d=$('fEntryDate'); if(d) d.min = '2025-09-02';
    syncReserved(); updateHint();

    var s=$('fStatus'); if(s) s.addEventListener('change', syncReserved);
    var l=$('fLabel');  if(l) l.addEventListener('change', syncReserved);

    if(d) d.addEventListener('change', function(){
      updateHint();
      persistEntry(d.value||'');
    });

    if(typeof window.selectLayer==='function'){ 
      var _sl = window.selectLayer;
      window.selectLayer = function(l, focusFirst){
        var r=_sl.call(this,l,focusFirst);
        try{ ensureReservedRow(); var d=$('fEntryDate'); if(d){ d.value=(layerProps(l).entryDate||''); persistEntry(d.value||''); } }catch(_ ){}
        syncReserved(); updateHint(); return r;
      };
    }
  });
})();
</script>
<script>
(function(){
  const isMobile = matchMedia('(hover:none), (pointer:coarse)').matches;
  function attach(){
    const input = document.getElementById('fEntryDate');
    if(!input || isMobile || input.dataset.hasPicker) return;
    input.dataset.hasPicker = '1';
    input.setAttribute('readonly','readonly');
    input.classList.add('has-button');
    const wrap = input.parentElement || input;
    const btn = document.createElement('button'); btn.type='button'; btn.className='date-open';
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="16" rx="4"></rect><line x1="8" y1="3" x2="8" y2="7"></line><line x1="16" y1="3" x2="16" y2="7"></line><line x1="3" y1="11" x2="21" y2="11"></line></svg>';
    wrap.style.position='relative'; wrap.appendChild(btn);

    let pop=null, cur=null; const minDate=new Date('2025-09-02'+'T00:00:00');
    function parseISO(iso){ try{ if(!iso) return null; const p=iso.split('-'); return new Date(+p[0], p[1]-1, +p[2]); }catch(e){ return null; } }
    function toISO(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+dd; }
    function sameDay(a,b){ return a&&b&&a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()&&a.getDate()==b.getDate(); }

    function position(){
      if(!pop) return; const r=input.getBoundingClientRect();
      const above=(window.scrollY + r.top - pop.offsetHeight - 8);
      const below=(window.scrollY + r.bottom + 8);
      const useAbove = above >= window.scrollY + 8;
      pop.style.top=(useAbove?above:below)+'px'; pop.style.left=(window.scrollX + r.left)+'px';
    }
    function close(){ if(pop){ pop.remove(); pop=null; } }
    function render(){
      const sel=parseISO(input.value); const today=new Date(); today.setHours(0,0,0,0);
      const month=cur.getMonth(), year=cur.getFullYear();
      const header=`<div class="dp-header"><div class="dp-title">${['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'][month]} ${year}</div><div class="dp-nav"><div class="dp-btn" data-nav="-1">‹</div><div class="dp-btn" data-nav="1">›</div></div></div>`;
      const wd=['L','M','M','J','V','S','D'].map(w=>`<div class="dp-weekday">${w}</div>`).join('');
      const first=new Date(year,month,1); const start=(first.getDay()+6)%7; const days=new Date(year,month+1,0).getDate();
      const cells=[]; for(let i=0;i<start;i++) cells.push('<div></div>');
      for(let d=1; d<=days; d++){ const dt=new Date(year,month,d); dt.setHours(0,0,0,0);
        const iso=toISO(dt); const dis=dt<minDate; const cls=['dp-day']; if(sameDay(dt,today)) cls.push('today'); if(sel&&sameDay(dt,sel)) cls.push('selected'); if(dis) cls.push('disabled');
        cells.push(`<div class="${cls.join(' ')}" data-iso="${iso}">${d}</div>`);
      }
      const grid=`<div class="dp-grid">${wd}${cells.join('')}</div>`;
      const footer='<div class="dp-footer"><span class="dp-link" data-act="clear">Effacer</span><span class="dp-link" data-act="today">Aujourd\'hui</span></div>';
      pop.innerHTML=header+grid+footer;
      pop.querySelectorAll('.dp-btn').forEach(el=>el.addEventListener('click',()=>{ const step=parseInt(el.dataset.nav)||0; cur=new Date(year,month+step,1); render(); position(); }));
      pop.querySelectorAll('.dp-day').forEach(el=>el.addEventListener('click',()=>{ if(el.classList.contains('disabled')) return; const iso=el.getAttribute('data-iso'); input.value=iso; input.dispatchEvent(new Event('change',{bubbles:true})); close(); }));
      const clear=pop.querySelector('[data-act="clear"]'); const todayBtn=pop.querySelector('[data-act="today"]');
      if(clear) clear.addEventListener('click', ()=>{ input.value=''; input.dispatchEvent(new Event('change',{bubbles:true})); close(); });
      if(todayBtn) todayBtn.addEventListener('click', ()=>{ const t=new Date(); t.setHours(0,0,0,0); if(t>=minDate){ input.value=toISO(t); input.dispatchEvent(new Event('change',{bubbles:true})); close(); } });
    }
    function open(){
      if(pop) return; pop=document.createElement('div'); pop.className='datepicker-popover';
      const sel=parseISO(input.value); const today=new Date(); today.setHours(0,0,0,0);
      cur= sel ? new Date(sel.getFullYear(), sel.getMonth(), 1) : new Date(today.getFullYear(), today.getMonth(), 1);
      render(); document.body.appendChild(pop); position();
      setTimeout(()=>{ 
        function onDoc(e){ if(!pop) return; if(e.target===input||e.target===btn||pop.contains(e.target)) return; close(); document.removeEventListener('mousedown', onDoc); document.removeEventListener('focusin', onDoc); window.removeEventListener('resize', position); window.removeEventListener('scroll', position, true); }
        document.addEventListener('mousedown', onDoc); document.addEventListener('focusin', onDoc);
        window.addEventListener('resize', position); window.addEventListener('scroll', position, true);
      },0);
    }
    input.addEventListener('focus', open); btn.addEventListener('click', open);
  }
  document.addEventListener('DOMContentLoaded', attach);
})();
</script>


<script>
// === Tooltip badge for "Réservé" (safe, no core edits) ===
(function(){
  function attach(){
    if(!window.map || typeof window.map.on !== 'function'){ setTimeout(attach, 250); return; }
    map.on('tooltipopen', function(e){
      try{
        var ep = (typeof layerProps==='function') ? layerProps(e.layer) : (e.layer && e.layer.options && e.layer.options.ep) || {};
        if(ep && ep.status === "Réservé" && ep.entryDate){
          var d = new Date(ep.entryDate + "T00:00:00");
          var t = new Date(); t.setHours(0,0,0,0);
          var diff = Math.round((d - t)/86400000);
          if(!isNaN(diff)){
            var el = e.tooltip && e.tooltip.getElement ? e.tooltip.getElement() : null;
            if(el){
              var content = el.querySelector('.leaflet-tooltip-content') || el;
              // Remove previous entry badge to avoid duplicates
              var prev = content.querySelector('[data-badge="entry"]');
              if(prev) prev.remove();
              // Build badge
              var span = document.createElement('span');
              span.setAttribute('data-badge','entry');
              span.className = 'tt-badge' + (diff < 0 ? ' alert' : '');
              span.textContent = '⏳ ' + (diff < 0 ? Math.abs(diff) + ' j dépassé' : diff + ' j');
              // Separator " · "
              content.appendChild(document.createTextNode(' · '));
              content.appendChild(span);
            }
          }
        }
      }catch(_){}
    });
  }
  attach();
})();
</script>


<script>
// === Patch Leaflet bindTooltip to append ⏳ badge for "Réservé" even if map isn't global ===
(function(){
  function normalize(s){
    try{ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim(); }catch(e){ return (s||'').toString().toLowerCase().trim(); }
  }
  function buildBadge(diff){
    var cls = 'tt-badge' + (diff < 0 ? ' alert' : '');
    var label = '⏳ ' + (diff < 0 ? Math.abs(diff) + ' j dépassé' : diff + ' j');
    return '<span class="'+cls+'" data-badge="entry">'+label+'</span>';
  }

  function ready(fn){
    if(window.L && L.Layer && L.Layer.prototype && typeof L.Layer.prototype.bindTooltip === 'function'){ fn(); }
    else setTimeout(()=>ready(fn), 200);
  }

  ready(function(){
    var original = L.Layer.prototype.bindTooltip;
    L.Layer.prototype.bindTooltip = function(content, options){
      try{
        var ep = (typeof layerProps==='function') ? layerProps(this) : (this.options && this.options.ep) || {};
        var st = normalize(ep.status);
        if(st === 'reserve' && ep.entryDate){
          var d = new Date(ep.entryDate + 'T00:00:00');
          var t = new Date(); t.setHours(0,0,0,0);
          var diff = Math.round((d - t)/86400000);
          if(!isNaN(diff) && typeof content === 'string' && !/data-badge="entry"/.test(content)){
            content += ' · ' + buildBadge(diff);
          }
        }
      }catch(_){}
      return original.call(this, content, options);
    };
  });
})();
</script>


<script>
// === Wrapper setLayerProps : garantit qu'entryDate n'est pas perdu par "Appliquer" ===
(function(){
  function $(id){ return document.getElementById(id); }
  function isEvent(){ return $('fLabel') && $('fLabel').value === 'Evenementiel'; }
  function isReserved(){ return $('fStatus') && $('fStatus').value === 'Réservé'; }

  function ready(fn){
    if(typeof window.setLayerProps === 'function'){ fn(); }
    else setTimeout(function(){ ready(fn); }, 200);
  }

  ready(function(){
    var _set = window.setLayerProps;
    window.setLayerProps = function(layer, props){
      try{
        props = props || {};
        var hasEntry = Object.prototype.hasOwnProperty.call(props, 'entryDate');
        if(!hasEntry){
          // Préserver/ajouter entryDate selon le statut courant du formulaire
          var ep = (typeof layerProps==='function') ? layerProps(layer) : (layer && layer.options && layer.options.ep) || {};
          var formVal = ($('fEntryDate') && $('fEntryDate').value) || '';
          if(!isEvent() && isReserved()){
            props.entryDate = formVal || ep.entryDate || '';
          }else{
            props.entryDate = ''; // autre statut : on vide
          }
        }
      }catch(e){}
      var r = _set.apply(this, arguments);
      try{
        // Miroir en fallback dans options + refresh visuel
        if(layer && layer.options){
          layer.options.ep = layer.options.ep || {};
          if(typeof props.entryDate !== 'undefined') layer.options.ep.entryDate = props.entryDate;
        }
        if(typeof applyStyle==='function'){ try{ applyStyle(layer); }catch(_){ } }
      }catch(_){}
      return r;
    };
  });
})();
</script>
<script>
  // Helpers pour trouver bâtiment / étage depuis tes <select>
  function getBuilding() {
    const el = document.querySelector('#buildingSelect, select[name="building"]');
    return el ? el.value : 'A';
  }
  function getFloor() {
    const el = document.querySelector('#floorSelect, select[name="floor"]');
    return el ? el.value : 'RDJ';
  }

  // Fallback d’URL: on tente /api/history-list puis /api/history/list si 404
  async function fetchHistoryList(building, floor) {
    let r = await fetch(`/api/history-list?building=${encodeURIComponent(building)}&floor=${encodeURIComponent(floor)}`);
    if (r.status === 404) r = await fetch(`/api/history/list?building=${encodeURIComponent(building)}&floor=${encodeURIComponent(floor)}`);
    if (!r.ok) throw new Error('Impossible de charger la liste');
    const json = await r.json();
    return Array.isArray(json) ? json : (json.items || []);
  }

  async function restoreSnapshot(building, floor, at) {
    // On tente en POST sur /api/history-restore, sinon /api/history/restore
    let r = await fetch(`/api/history-restore?building=${encodeURIComponent(building)}&floor=${encodeURIComponent(floor)}&at=${encodeURIComponent(at)}`, { method: 'POST' });
    if (r.status === 404) r = await fetch(`/api/history/restore?building=${encodeURIComponent(building)}&floor=${encodeURIComponent(floor)}&at=${encodeURIComponent(at)}`, { method: 'POST' });
    if (!r.ok) throw new Error('Restauration impossible');
    // Recharge la page pour voir l’état restauré
    location.reload();
  }

  function formatWhen(v) {
    try {
      const d = new Date(v || Date.now());
      return d.toLocaleString();
    } catch { return String(v); }
  }

  // Ouverture / fermeture du panneau + rendu de la liste
  (function wireHistoryUI(){
    const btn = document.getElementById('btnHistory');
    const panel = document.getElementById('historyPanel');
    const list = document.getElementById('historyList');
    const closeBtn = document.getElementById('historyClose');
    if (!btn || !panel || !list || !closeBtn) return;

    async function openPanel() {
      panel.style.display = 'block';
      list.textContent = 'Chargement…';
      const b = getBuilding();
      const f = getFloor();
      try {
        const items = await fetchHistoryList(b, f);
        if (!items.length) {
          list.innerHTML = '<div style="padding:6px; color:#666;">Aucune version pour ce niveau.</div>';
          return;
        }
        list.innerHTML = items.map(it => {
          const label = formatWhen(it.created_at || it.at || it.timestamp || it.date);
          const note = it.note ? ` — ${it.note}` : '';
          const at = it.at || it.created_at || it.timestamp || '';
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px solid #f0f0f0;">
              <div style="font-size:14px; line-height:1.2;">
                <div><strong>${label}</strong></div>
                <div style="color:#666; font-size:12px;">${note}</div>
              </div>
              <button class="btn" data-at="${at}">Restaurer</button>
            </div>
          `;
        }).join('');
        // brancher les boutons "Restaurer"
        list.querySelectorAll('button[data-at]').forEach(btnR => {
          btnR.addEventListener('click', (e) => {
            const at = e.currentTarget.getAttribute('data-at');
            if (!at) return;
            const b = getBuilding(), f = getFloor();
            restoreSnapshot(b, f, at);
          });
        });
      } catch (e) {
        list.innerHTML = `<div style="padding:6px; color:#b00020;">${e.message}</div>`;
      }
    }

    btn.addEventListener('click', () => {
  if (panel.style.display === 'block') {
    panel.style.display = 'none';        // toggle: ferme si déjà ouvert
  } else {
    openPanel();                           // sinon, ouvre + recharge la liste
  }
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') panel.style.display = 'none';
});

    closeBtn.addEventListener('click', () => { panel.style.display = 'none'; });
    document.addEventListener('click', (e) => {
      if (!panel.contains(e.target) && e.target !== btn) panel.style.display = 'none';
    });
  })();
</script>
  <script>
  (function(){
    const historyBtn = document.getElementById('btnHistory');

    function syncHistoryVisibility(){
      // Si le bouton "Appliquer" existe (== mode Admin), on montre "Historique".
      const applyBtn = document.getElementById('btnApply');
      if (!historyBtn) return;
     historyBtn.style.display = document.body.classList.contains('admin') ? 'inline-block' : 'none';
    }

    // 1) On vérifie maintenant
    syncHistoryVisibility();

    // 2) On revérifie si le DOM change (par ex. quand le panneau Admin apparaît)
    const obs = new MutationObserver(syncHistoryVisibility);
    obs.observe(document.body, { childList: true, subtree: true });
  })();
</script>


</body>
</html>
