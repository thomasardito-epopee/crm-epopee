<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Épopée - Exploitation</title>

  <!-- Favicon (évite les 404 : ne garder que ce qui existe réellement) -->
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">

  <!-- Styles de base (facultatif) -->
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }
    .app { display: grid; grid-template-columns: 280px 1fr; grid-template-rows: auto 1fr; height: 100%; }
    header { grid-column: 1 / -1; padding: 10px 16px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 12px; }
    header h1 { font-size: 18px; margin: 0; font-weight: 600; }
    .sidebar { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    .content { display: grid; grid-template-columns: 1fr 420px; gap: 12px; padding: 12px; overflow: auto; }
    #map { width: 100%; height: calc(100vh - 120px); min-height: 420px; background: #f5f5f5; border-radius: 8px; }
    .panel { background: rgba(0,0,0,0.02); border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    .panel h4 { margin: 0 0 8px; font-size: 15px; }
    .rowlist { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #e6e6e6; }
    .rowlist:last-child { border-bottom: none; }
    .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid #ccc; }
    .hint { color: #777; font-size: 13px; padding: 6px 0; }
    select, button { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: transparent; }
    .grid-v { display: grid; gap: 8px; }
    .grid-h { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Épopée – Exploitation</h1>
      <div class="grid-h">
        <label for="buildingSelect">Bâtiment :</label>
        <select id="buildingSelect">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>
      <div class="grid-h">
        <label for="floorSelect">Étage :</label>
        <select id="floorSelect">
          <option value="0">RDC</option>
          <option value="1">+1</option>
          <option value="2">+2</option>
        </select>
      </div>
      <button id="btnRefresh">Rafraîchir</button>
    </header>

    <aside class="sidebar">
      <div class="panel">
        <h4>Liste “Réservés”</h4>
        <div id="reservedList"></div>
      </div>
      <div class="panel" style="margin-top:12px">
        <h4>Outils</h4>
        <div class="grid-v">
          <button id="btnSnapshot">Snapshot (save)</button>
          <button id="btnHistory">Voir l’historique</button>
          <button id="btnRestore">Restaurer (latest)</button>
        </div>
      </div>
    </aside>

    <main class="content">
      <div id="map" class="panel"></div>
      <div id="visitorBoard" class="panel">
        <h4>Dashboard</h4>
        <div class="grid-h" style="margin-bottom:8px">
          <span>Vue :</span>
          <select id="kpiScope">
            <option value="building" selected>Bâtiment</option>
            <option value="floor">Étage</option>
          </select>
        </div>
        <div id="kpiContent" class="grid-v">
          <!-- Rendu KPI -->
        </div>
      </div>
    </main>
  </div>

  <!-- Librairies externes -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

  <!-- pdf.js (core) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-9Wz9p4Y0oFLSgYRX4oUPI8kYKmY5x9F9xwEoz4XcywZfVxB4fKCBzCRm8Yq5p3xGQ9rA2sM91b4A5Aq7JrZqJg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Helpers + App -->
  <script>
    // ===== Helpers DOM (doivent être définis AVANT toute utilisation) =====
    const $  = (id, root=document) => root.getElementById ? root.getElementById(id) : document.getElementById(id);
    const qs = (sel, root=document) => root.querySelector(sel);
    const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // ===== PDF.js worker (évite les erreurs de worker introuvable) =====
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }

    // ===== État minimal pour démo (remplace/étends avec ton vrai state) =====
    const S = {
      building: "A",
      floor: "0",
      reservedList: [
        { code: "A-101", label: "Bureau 101", area: 22 },
        { code: "A-205", label: "Open-space", area: 120 },
        { code: "B-010", label: "Salle réunion", area: 18 },
      ]
    };

    // ===== Rendu UI minimal (exemples) =====
    function renderReservedList() {
      const r = $("reservedList");
      if (!S.reservedList || S.reservedList.length === 0) {
        r.innerHTML = '<div class="hint">Aucun espace réservé.</div>';
        return;
      }
      r.innerHTML = S.reservedList
        .slice().sort((a,b) => (b.area||0)-(a.area||0))
        .map(v => `
          <div class="rowlist">
            <div>${v.code} — ${v.label}</div>
            <div class="badge">${v.area||0} m²</div>
            <div class="badge">Réservé</div>
          </div>
        `).join("");
    }

    function renderDashboard() {
      const kpiScope = $("kpiScope")?.value || "building";
      const el = $("kpiContent");
      el.innerHTML = `
        <div class="rowlist"><div>Total espaces</div><div class="badge">42</div></div>
        <div class="rowlist"><div>Occupés (${kpiScope})</div><div class="badge">28</div></div>
        <div class="rowlist"><div>Disponibles</div><div class="badge">14</div></div>
        <div class="hint">Scope actuel : <b>${kpiScope}</b></div>
      `;
    }

    // ===== Carte Leaflet (exemple simple) =====
    let map;
    function initMap() {
      map = L.map('map', { zoomControl: true }).setView([43.310, 5.390], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      L.marker([43.310, 5.390]).addTo(map).bindPopup('Épopée Village');
    }

    // ===== Listeners =====
    function wireUI() {
      $("buildingSelect").addEventListener("change", (e) => {
        S.building = e.target.value;
        renderDashboard();
      });
      $("floorSelect").addEventListener("change", (e) => {
        S.floor = e.target.value;
        renderDashboard();
      });
      $("kpiScope").addEventListener("change", renderDashboard);
      $("btnRefresh").addEventListener("click", () => {
        renderReservedList();
        renderDashboard();
      });
      $("btnSnapshot").addEventListener("click", () => {
        // TODO: appeler /functions/history-save en prod si dispo
        alert("Snapshot local (démo).");
      });
      $("btnHistory").addEventListener("click", () => {
        // TODO: ouvrir panneau/historique
        alert("Historique (démo).");
      });
      $("btnRestore").addEventListener("click", () => {
        // TODO: appeler /functions/history-restore
        alert("Restore (démo).");
      });
    }

    // ===== Boot =====
    document.addEventListener("DOMContentLoaded", () => {
      // === BEGIN APP LOGIC ===
      // Si tu as un gros bloc de logique existant, colle-le ici,
      // en gardant les helpers $, qs, qsa tout en haut.
      // ========================================================

      initMap();
      renderReservedList();
      renderDashboard();
      wireUI();
    });
  </script>
</body>
</html>
